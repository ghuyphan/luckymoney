<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>üßß L√¨ X√¨ May M·∫Øn</title>
    <link rel="icon" href="favicon.png" type="image/png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700;800&family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
        rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root {
            --red-primary: #C41E3A;
            --red-dark: #8B0000;
            --red-light: #FF4444;
            --gold-primary: #FFD700;
            --gold-light: #FFEC8B;
            --gold-dark: #DAA520;
            --cream: #FFF8DC;
            --white: #FFFFFF;
            --medical-blue: #008080;
            --medical-light: #E0F2F1;
            --medical-glass: rgba(0, 128, 128, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            font-size: clamp(14px, 2vw, 16px);
            -webkit-text-size-adjust: 100%;
        }

        body {
            font-family: 'Be Vietnam Pro', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            min-height: 100dvh;
            background: linear-gradient(135deg, var(--red-dark) 0%, var(--red-primary) 60%, var(--medical-blue) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: clamp(1rem, 4vw, 2rem);
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background-image:
                radial-gradient(circle at 20% 80%, rgba(0, 128, 128, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(255, 215, 0, 0.1) 0%, transparent 50%),
                url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M30 0v60M0 30h60' stroke='rgba(255,255,255,0.05)' stroke-width='1'/%3E%3Cpath d='M25 25h10v10H25z' fill='rgba(255,215,0,0.05)'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        .container {
            position: relative;
            z-index: 1;
            text-align: center;
            width: 100%;
            max-width: min(500px, 95vw);
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 3.5rem;
        }

        /* Medical Heartbeat Animation */
        .ecg-line {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 100px;
            pointer-events: none;
            z-index: 0;
            opacity: 0.1;
        }

        /* --- THEMES --- */
        body.theme-normal {
            background: linear-gradient(135deg, #8E0000 0%, #B71C1C 50%, #900000 100%) !important;
            background-size: cover;
            background-position: center center;
            background-attachment: fixed;
            background-repeat: no-repeat;
        }

        body.theme-normal::before {
            content: none;
        }

        body.theme-normal::after {
            content: none;
        }

        /* --- UI COMPONENTS --- */

        .utility-bar {
            position: fixed;
            top: 1rem;
            left: 1rem;
            display: flex;
            gap: 0.5rem;
            z-index: 100;
        }

        .ecg-path {
            fill: none;
            stroke: var(--white);
            stroke-width: 2;
            stroke-dasharray: 1000;
            stroke-dashoffset: 1000;
            animation: ecgDraw 3s linear infinite;
        }

        /* Header */
        .header {
            margin-bottom: clamp(1.25rem, 4vw, 2rem);
            animation: fadeInDown 0.8s ease-out;
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.75rem, 7vw, 3.5rem);
            color: var(--gold-primary);
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3), 0 0 30px rgba(255, 215, 0, 0.3);
            margin-bottom: 0.5rem;
            letter-spacing: 1px;
            line-height: 1.2;
        }

        .header p {
            color: var(--cream);
            font-size: clamp(0.9rem, 3vw, 1.1rem);
            opacity: 0.9;
        }

        /* Share Button */
        .share-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-light));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--red-primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            cursor: pointer;
            z-index: 100;
            transition: all 0.3s ease;
            border: 2px solid white;
        }

        .share-btn:hover {
            transform: scale(1.1) rotate(15deg);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.5);
        }

        /* Share Modal */
        .share-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .share-modal {
            background: #fffafa;
            width: 90%;
            max-width: 350px;
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            position: relative;
            border: 2px solid var(--gold-primary);
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            animation: modalPop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .qr-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
            margin: 1.5rem auto;
            display: flex;
            justify-content: center;
            width: fit-content;
        }

        .share-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-top: 1rem;
        }

        .share-action-btn {
            padding: 10px;
            border-radius: 10px;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .btn-copy {
            background: #f0f0f0;
            color: #333;
        }

        .btn-copy:hover {
            background: #e0e0e0;
        }

        .btn-download {
            background: var(--red-primary);
            color: var(--gold-light);
        }

        .btn-download:hover {
            background: var(--red-dark);
        }

        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 1.5rem;
            color: #999;
            cursor: pointer;
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-radius: 50%;
            background: #f5f5f5;
        }

        .close-modal:hover {
            background: #eee;
            color: #333;
        }

        .department-badge {
            display: inline-block;
            background: linear-gradient(135deg, var(--medical-blue), #004D40);
            color: var(--white);
            padding: clamp(0.5rem, 1.5vw, 0.7rem) clamp(1.2rem, 3vw, 1.8rem);
            border-radius: 50px;
            font-weight: 600;
            font-size: clamp(0.75rem, 2.5vw, 0.95rem);
            margin-top: 0.75rem;
            box-shadow: 0 4px 15px rgba(0, 128, 128, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Envelope */
        /* Envelope */
        .envelope-container {
            perspective: 1200px;
            margin: clamp(5rem, 15vw, 6rem) auto 2rem;
            cursor: pointer;
            -webkit-tap-highlight-color: transparent;
            filter: drop-shadow(0 20px 30px rgba(0, 0, 0, 0.3));
        }

        .envelope {
            width: clamp(220px, 65vw, 260px);
            height: clamp(320px, 95vw, 380px);
            margin: 0 auto;
            position: relative;
            transition: transform 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            animation: float 4s ease-in-out infinite;
            transform-style: preserve-3d;
        }

        .envelope:hover {
            animation: shake 0.5s ease-in-out infinite;
            cursor: pointer;
        }

        .envelope:active {
            transform: scale(0.96) translateY(5px);
        }

        .envelope.shake-click {
            animation: shake 0.5s ease-in-out infinite;
        }

        @keyframes shake {

            0%,
            100% {
                transform: rotate(0deg);
            }

            25% {
                transform: rotate(-3deg);
            }

            75% {
                transform: rotate(3deg);
            }
        }

        .envelope-body {
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 50% 30%, #D32F2F 0%, #B71C1C 60%, #8b0000 100%);
            border-radius: 12px;
            position: relative;
            box-shadow:
                inset 0 0 30px rgba(0, 0, 0, 0.4),
                0 0 0 2px #d4af37,
                0 0 0 5px #8b0000,
                0 0 0 7px #d4af37;
            overflow: hidden;
        }

        .envelope-body::before {
            content: 'Á¶è';
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: clamp(4rem, 18vw, 6rem);
            font-family: "Playfair Display", serif;
            font-weight: 800;
            background: linear-gradient(to bottom, #FFD700 20%, #B8860B 50%, #FFD700 80%);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
            opacity: 0.9;
            z-index: 1;
        }

        .envelope-pattern {
            position: absolute;
            inset: 0;
            opacity: 0.1;
            background-image:
                repeating-linear-gradient(45deg, #FFD700 0, #FFD700 1px, transparent 0, transparent 40px),
                repeating-linear-gradient(-45deg, #FFD700 0, #FFD700 1px, transparent 0, transparent 40px);
            mix-blend-mode: overlay;
        }

        .envelope-flap {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 32%;
            background: linear-gradient(160deg, #C62828 0%, #8E0000 100%);
            clip-path: ellipse(80% 100% at 50% 0%);
            transform-origin: top center;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 2;
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        /* Gold trim accent for flap */
        .envelope-flap::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 100%, rgba(255, 215, 0, 0.2) 0%, transparent 60%);
            pointer-events: none;
        }

        .envelope-seal {
            position: absolute;
            top: 26%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: clamp(48px, 14vw, 64px);
            height: clamp(48px, 14vw, 64px);
            background: radial-gradient(circle at 35% 35%, #FFD700 0%, #DAA520 50%, #B8860B 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3;
            box-shadow:
                0 4px 15px rgba(0, 0, 0, 0.5),
                inset 0 0 0 2px rgba(255, 215, 0, 0.5),
                inset 0 0 4px 4px rgba(184, 134, 11, 0.3);
            transition: all 0.4s ease;
            font-size: clamp(1.5rem, 5vw, 2rem);
            color: #795548;
            border: 1px solid #B8860B;
        }

        /* Gold Skin (Unlocked at 1M) */
        .envelope.skin-gold .envelope-body {
            background: radial-gradient(circle at 50% 30%, #FFD700 0%, #FDB931 60%, #DAA520 100%);
            box-shadow:
                inset 0 0 20px rgba(255, 255, 255, 0.6),
                0 0 0 2px #FFF,
                0 0 0 5px #DAA520,
                0 0 0 7px #FFF;
        }

        .envelope.skin-gold .envelope-body::before {
            background: linear-gradient(to bottom, #d32f2f 20%, #b71c1c 50%, #d32f2f 80%);
            -webkit-background-clip: text;
            background-clip: text;
        }

        .envelope.skin-gold .envelope-flap {
            background: linear-gradient(160deg, #FDB931 0%, #DAA520 100%);
            filter: drop-shadow(0 4px 8px rgba(218, 165, 32, 0.4));
        }

        .envelope.skin-gold .envelope-seal {
            background: radial-gradient(circle at 35% 35%, #FFF 0%, #F0F0F0 100%);
            color: #DAA520;
            border: 1px solid #FFF;
            box-shadow:
                0 4px 15px rgba(0, 0, 0, 0.2),
                inset 0 0 0 2px rgba(218, 165, 32, 0.5);
        }

        .envelope.opened .envelope-flap {
            transform: rotateX(180deg) !important;
            z-index: 0;
            /* Move behind body when opened so card can come out */
        }

        /* Fix z-index when opening */
        .envelope.opened .envelope-body {
            overflow: visible;
        }

        .envelope.opened .envelope-seal {
            opacity: 0;
            transform: translate(-50%, -50%) scale(0);
        }

        .click-hint {
            color: var(--gold-light);
            font-size: clamp(0.85rem, 3vw, 1rem);
            margin-top: 1rem;
            animation: pulse 2s ease-in-out infinite;
        }

        .click-hint.hidden {
            display: none;
        }

        /* Result Card */
        .result-card {
            background: linear-gradient(135deg, var(--cream) 0%, #FFF 100%);
            border-radius: clamp(1rem, 4vw, 1.5rem);
            padding: clamp(1.25rem, 5vw, 2.5rem);
            margin-top: clamp(1.25rem, 4vw, 2rem);
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3), 0 0 0 4px var(--gold-primary);
            display: none;
            animation: popIn 0.5s ease-out;
            position: relative;
            overflow: hidden;
            width: 100%;
            max-width: min(450px, 95vw);
            transition: box-shadow 0.3s ease;
        }

        /* Rarity Styles */
        .result-card[data-rarity="SSR"] {
            box-shadow: 0 20px 60px rgba(255, 0, 0, 0.5), 0 0 0 6px #FFD700, 0 0 50px #FFD700;
            border: 2px solid #FFD700;
        }

        .result-card[data-rarity="SR"] {
            box-shadow: 0 20px 60px rgba(138, 43, 226, 0.4), 0 0 0 5px #9932CC;
        }

        .result-card[data-rarity="R"] {
            box-shadow: 0 20px 60px rgba(0, 191, 255, 0.3), 0 0 0 4px #00BFFF;
        }

        .result-card.show {
            display: block;
        }

        .result-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.1) 0%, transparent 70%);
            animation: shimmer 3s linear infinite;
        }

        .result-card .amount {
            font-family: 'Playfair Display', serif;
            font-size: clamp(2rem, 10vw, 4rem);
            font-weight: 800;
            background: linear-gradient(135deg, var(--red-primary), var(--red-dark));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.25rem;
            position: relative;
            z-index: 1;
        }

        .result-card .currency {
            font-size: clamp(1rem, 3.5vw, 1.3rem);
            color: var(--red-primary);
            font-weight: 600;
            margin-bottom: 1rem;
            position: relative;
            z-index: 1;
        }

        /* Money Display with Flip Card */
        .money-display {
            margin: 1.5rem 0;
            position: relative;
            z-index: 1;
        }

        .money-stack-container {
            position: relative;
            width: 100%;
            max-width: clamp(260px, 70vw, 340px);
            aspect-ratio: 2.2 / 1;
            margin: 0 auto;
            perspective: 1000px;
        }

        .money-stack-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 0.8s;
        }

        .money-stack-wrapper.flipped {
            transform: rotateY(180deg);
        }

        /* 3D Stack Transform */
        .money-card {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            border-radius: 12px;
            transform-style: preserve-3d;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transform: var(--stack-transform);
            /* Set by JS */
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            cursor: grab;
        }

        .money-card:active {
            transform: var(--stack-transform) scale(0.98);
        }

        .money-card.flipped {
            transform: var(--stack-transform) rotateY(180deg);
        }

        .money-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3), 0 0 0 2px rgba(255, 255, 255, 0.2);
        }

        .money-face img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .money-back {
            transform: rotateY(180deg);
        }

        .money-card.holo-active,
        .money-stack-wrapper.holo-active {
            transition: none !important;
        }

        /* Force transition during flip */
        .money-stack-wrapper.is-flipping {
            transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
        }

        .flip-hint {
            font-size: clamp(0.7rem, 2.5vw, 0.85rem);
            color: #888;
            margin-top: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .flip-icon {
            animation: flipHint 2s ease-in-out infinite;
        }

        /* Bounce Animation */
        @keyframes bounce {
            0% {
                transform: scale(0);
                opacity: 0;
            }

            50% {
                transform: scale(1.2);
            }

            70% {
                transform: scale(0.9);
            }

            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* Holo Animations */
        @keyframes holoShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes holoShineMove {
            0% {
                background-position: 200% 200%;
            }

            100% {
                background-position: -100% -100%;
            }
        }

        /* Wish */
        .result-card .wish {
            font-family: 'Playfair Display', serif;
            font-size: clamp(1.1rem, 4vw, 1.4rem);
            font-style: italic;
            color: var(--red-dark);
            line-height: 1.6;
            padding: clamp(3rem, 6vw, 4rem) clamp(1.5rem, 5vw, 2.5rem);
            background-color: #FFF;
            background-image:
                radial-gradient(var(--gold-light) 1px, transparent 1px),
                linear-gradient(to bottom, transparent, rgba(255, 248, 220, 0.3) 100%);
            background-size: 20px 20px, 100% 100%;
            border: 1px solid var(--gold-light);
            border-radius: 4px;
            margin-bottom: 1.5rem;
            position: relative;
            z-index: 1;
            text-align: center;
            box-shadow:
                inset 0 0 20px rgba(255, 215, 0, 0.1),
                0 5px 15px rgba(0, 0, 0, 0.05);
        }

        .result-card .wish::before {
            content: '‚ù¶';
            font-size: 2rem;
            color: var(--gold-primary);
            position: absolute;
            top: 0.5rem;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0.6;
        }

        .result-card .wish::after {
            content: '‚ù¶';
            font-size: 2rem;
            color: var(--gold-primary);
            position: absolute;
            bottom: 0.5rem;
            left: 50%;
            transform: translateX(-50%) rotate(180deg);
            opacity: 0.6;
        }

        /* Buttons */
        .buttons {
            display: flex;
            justify-content: center;
            gap: clamp(0.5rem, 2vw, 1rem);
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .btn {
            padding: clamp(0.7rem, 2.5vw, 0.9rem) clamp(1.5rem, 5vw, 2.5rem);
            font-size: clamp(0.9rem, 3vw, 1rem);
            font-weight: 600;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Be Vietnam Pro', sans-serif;
            position: relative;
            z-index: 1;
            -webkit-tap-highlight-color: transparent;
            flex: 1;
            min-width: 120px;
            max-width: 180px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gold-primary), var(--gold-dark));
            color: var(--red-dark);
            box-shadow: 0 6px 20px rgba(255, 215, 0, 0.4);
        }

        .btn-primary:hover,
        .btn-primary:active {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
        }

        .btn-secondary {
            background: transparent;
            color: var(--red-primary);
            border: 2px solid var(--red-primary);
        }

        .btn-secondary:hover,
        .btn-secondary:active {
            background: var(--red-primary);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #FF4444, #8B0000);
            color: white;
            box-shadow: 0 4px 15px rgba(139, 0, 0, 0.4);
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(139, 0, 0, 0.6);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Footer */
        .footer {
            margin-top: clamp(1.5rem, 5vw, 2.5rem);
            color: var(--cream);
            opacity: 0.7;
            font-size: clamp(0.75rem, 2.5vw, 0.9rem);
        }

        /* Confetti & Particles */
        .confetti-container {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1000;
            overflow: hidden;
        }

        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
        }

        .lucky-particles {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 0;
        }

        .particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: var(--gold-primary);
            border-radius: 50%;
            animation: particleFloat 15s linear infinite;
            opacity: 0.3;
        }

        /* Animations */
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
            }
        }

        @keyframes popIn {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes shimmer {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        @keyframes confettiFall {
            0% {
                opacity: 1;
                transform: translateY(-100vh) rotate(0deg);
            }

            100% {
                opacity: 0;
                transform: translateY(100vh) rotate(720deg);
            }
        }

        @keyframes particleFloat {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }

            10% {
                opacity: 0.3;
            }

            90% {
                opacity: 0.3;
            }

            100% {
                transform: translateY(-100vh) rotate(360deg);
                opacity: 0;
            }
        }

        @keyframes flipHint {

            0%,
            100% {
                transform: rotateY(0deg);
            }

            50% {
                transform: rotateY(180deg);
            }
        }

        /* Jackpot Effects */
        .jackpot-mode body {
            animation: shake-hard 0.5s ease-in-out;
        }

        .jackpot-mode .container {
            animation: shake-hard 0.5s ease-in-out;
        }

        @keyframes shake-hard {
            0% {
                transform: translate(0, 0) rotate(0deg);
            }

            10% {
                transform: translate(-10px, -10px) rotate(-5deg);
            }

            20% {
                transform: translate(10px, 10px) rotate(5deg);
            }

            30% {
                transform: translate(-10px, 10px) rotate(-5deg);
            }

            40% {
                transform: translate(10px, -10px) rotate(5deg);
            }

            50% {
                transform: translate(-5px, -5px) rotate(-2deg);
            }

            60% {
                transform: translate(5px, 5px) rotate(2deg);
            }

            100% {
                transform: translate(0, 0) rotate(0deg);
            }
        }

        .jackpot-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle, rgba(255, 215, 0, 0.4) 0%, transparent 70%);
            z-index: 999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
            mix-blend-mode: overlay;
        }

        .jackpot-active .jackpot-overlay {
            opacity: 1;
            animation: pulse-gold 2s infinite;
        }

        @keyframes pulse-gold {

            0%,
            100% {
                opacity: 0.3;
            }

            50% {
                opacity: 0.7;
            }
        }

        @keyframes ecgDraw {
            0% {
                stroke-dashoffset: 1000;
                opacity: 1;
            }

            80% {
                opacity: 1;
            }

            100% {
                stroke-dashoffset: 0;
                opacity: 0;
            }
        }

        /* Wallet styles */
        .wallet-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid var(--gold-primary);
            border-radius: 50px;
            padding: 0.5rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            z-index: 100;
            color: var(--gold-primary);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            font-family: 'Be Vietnam Pro', sans-serif;
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            max-width: calc(100vw - 160px);
            /* Prevent overlap with utility bar */
        }

        .wallet-container.update {
            transform: scale(1.1);
        }

        .wallet-balance {
            font-weight: 700;
            font-size: 1.1rem;
        }

        .withdraw-btn {
            background: var(--red-primary);
            color: #fff;
            border: none;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            cursor: pointer;
            margin-left: 0.5rem;
            transition: all 0.2s;
        }

        .withdraw-btn:hover {
            transform: scale(1.05);
            background: var(--red-dark);
        }

        .withdraw-btn:active {
            transform: scale(0.95);
        }

        .fake-notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-150%);
            opacity: 0;
            width: 95%;
            max-width: 380px;
            background: rgba(240, 240, 240, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            padding: 12px 15px;
            border-radius: 18px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            display: flex;
            flex-direction: column;
            gap: 8px;
            z-index: 10000;
            border: 1px solid rgba(255, 255, 255, 0.4);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #000;
            will-change: transform, opacity;
            transition: transform 0.4s cubic-bezier(0.19, 1, 0.22, 1),
                opacity 0.4s cubic-bezier(0.19, 1, 0.22, 1);
            pointer-events: none;
        }

        .fake-notification.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .fake-notification-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #666;
        }

        .fake-notification-header .app-info {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .fake-notification-header .app-icon {
            width: 20px;
            height: 20px;
            border-radius: 5px;
            background: #004D40;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: bold;
        }

        .fake-notification-header .app-name {
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.02em;
        }

        .fake-notification-header .time {
            font-size: 0.75rem;
        }

        .fake-notification-content {
            font-size: 0.95rem;
            line-height: 1.3;
            color: #000;
            display: -webkit-box;
            -webkit-line-clamp: 4;
            line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
            font-weight: 400;
        }

        .wallet-currency {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Very small screens - hide decorations */
        @media (max-width: 320px) {

            .result-card .wish::before,
            .result-card .wish::after {
                display: none;
            }

            .result-card .wish {
                padding: 1.5rem 1rem;
            }
        }

        /* Responsive */
        @media (max-width: 360px) {
            .buttons {
                flex-direction: column;
                align-items: center;
            }

            .btn {
                width: 100%;
                max-width: 200px;
            }

            .utility-bar {
                gap: 0.3rem;
            }

            .icon-btn {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .wallet-container {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }

            .wallet-balance {
                font-size: 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .department-badge {
                font-size: 0.7rem;
                padding: 0.4rem 1rem;
            }

            .result-card .wish {
                padding: 2.5rem 1rem;
                font-size: 1rem;
            }

            /* Smaller decorations on mobile */
            .result-card .wish::before,
            .result-card .wish::after {
                font-size: 1.2rem;
                opacity: 0.4;
            }
        }

        /* Small phones */
        @media (max-width: 480px) {
            .container {
                margin-top: 4rem;
            }

            .envelope {
                width: clamp(180px, 55vw, 220px);
                height: clamp(270px, 82vw, 330px);
            }

            .money-stack-container {
                max-width: clamp(220px, 65vw, 300px);
            }

            .modal-content {
                width: 98%;
                max-height: 85vh;
            }

            .bank-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                gap: 8px;
                max-height: 220px;
            }

            .bank-item {
                min-height: 60px;
                padding: 8px 4px;
            }

            .bank-item img {
                height: 24px;
            }

            .bank-item span {
                font-size: 0.6rem;
            }

            .share-btn {
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
                bottom: 15px;
                right: 15px;
            }

            /* Smaller decorations on small phones */
            .result-card .wish::before,
            .result-card .wish::after {
                font-size: 1.4rem;
                opacity: 0.5;
            }

            .result-card .wish {
                padding: 2.5rem 1rem;
            }
        }

        /* Medium screens */
        @media (min-width: 481px) and (max-width: 768px) {
            .container {
                max-width: 480px;
            }

            .result-card {
                max-width: 420px;
            }
        }

        /* Large screens */
        @media (min-width: 768px) {
            .container {
                max-width: 550px;
            }

            .money-card {
                max-width: 380px;
            }

            .modal-content {
                max-width: 520px;
            }

            .bank-grid {
                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
            }

            .utility-bar {
                top: 1.5rem;
                left: 1.5rem;
                gap: 0.75rem;
            }

            .icon-btn {
                width: 45px;
                height: 45px;
                font-size: 1.3rem;
            }

            .wallet-container {
                top: 1.5rem;
                right: 1.5rem;
            }
        }

        /* Landscape phones */
        @media (max-height: 500px) and (orientation: landscape) {
            .container {
                margin-top: 1rem;
            }

            .envelope {
                width: 140px;
                height: 210px;
            }

            .envelope-container {
                margin: 2rem auto 1rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.85rem;
            }

            .department-badge {
                display: none;
            }

            .result-card {
                padding: 1rem;
            }

            .result-card .amount {
                font-size: 2rem;
            }

            .money-stack-container {
                max-width: 200px;
            }

            .result-card .wish {
                padding: 1.5rem 1rem;
                font-size: 0.95rem;
            }

            /* Hide decorations on landscape - not enough space */
            .result-card .wish::before,
            .result-card .wish::after {
                display: none;
            }
        }

        /* Typewriter Cursor */
        .typing-cursor::after {
            content: '|';
            animation: blink 1s step-end infinite;
            color: var(--red-primary);
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Safe area for notched phones */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(1rem, env(safe-area-inset-left));
                padding-right: max(1rem, env(safe-area-inset-right));
                padding-bottom: max(1rem, env(safe-area-inset-bottom));
            }
        }

        /* FIX: Improved no-scroll - no padding-right to avoid layout shift */
        body.no-scroll {
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
        }

        /* --- NEW SKINS --- */
        /* Holographic Skin (Pokemon Style) */
        .envelope.skin-holo .envelope-body {
            background: linear-gradient(135deg,
                    #c0c0ff 0%, #ffc0cb 20%, #ffffc0 40%,
                    #c0ffc0 60%, #c0ffff 80%, #c0c0ff 100%);
            background-size: 300% 300%;
            animation: holoShift 4s ease infinite;
            border: 2px solid rgba(255, 255, 255, 0.5);
            box-shadow:
                0 4px 20px rgba(192, 192, 255, 0.4),
                inset 0 0 30px rgba(255, 255, 255, 0.3);
            overflow: hidden;
        }

        .envelope.skin-holo .envelope-body::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(125deg,
                    rgba(255, 255, 255, 0) 0%,
                    rgba(255, 255, 255, 0.4) 45%,
                    rgba(255, 255, 255, 0) 50%,
                    rgba(255, 255, 255, 0) 100%);
            background-size: 200% 200%;
            background-repeat: no-repeat;
            animation: holoShineMove 3s ease infinite;
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        .envelope.skin-holo .envelope-flap {
            background: linear-gradient(135deg, #c0c0ff 0%, #ffc0cb 50%, #ffffc0 100%);
            background-size: 200% 200%;
            animation: holoShift 4s ease infinite;
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-top: none;
        }

        /* Diamond Skin (10M) */
        .envelope.skin-diamond .envelope-body {
            background: linear-gradient(135deg, #e0f7fa 0%, #80deea 100%);
            border: 3px solid #fff;
            box-shadow: 0 0 30px #00e5ff;
        }

        .envelope.skin-diamond .envelope-flap {
            background: linear-gradient(135deg, #b2ebf2 0%, #4dd0e1 100%);
        }

        .icon-btn {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--gold-primary);
            color: var(--gold-primary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .icon-btn:hover {
            background: rgba(0, 0, 0, 0.6);
            transform: scale(1.1);
        }

        .icon-btn:active {
            transform: scale(0.95);
        }

        /* Modal - FIXED */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-overlay.open {
            display: flex;
        }

        .modal-content {
            background: var(--white);
            width: 95%;
            max-width: 500px;
            border-radius: 1rem;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 2px solid var(--gold-primary);
            animation: popIn 0.3s ease-out;
        }

        .modal-header {
            padding: 1rem;
            background: var(--red-primary);
            color: var(--white);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            font-size: 1.2rem;
            /* Prevent clicks from bubbling through */
            position: relative;
            z-index: 10;
        }

        .modal-body {
            padding: 1rem;
            overflow-y: auto;
            color: #333;
            /* Ensure body doesn't close modal on click */
            position: relative;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            line-height: 1;
        }

        .close-btn:hover {
            opacity: 0.8;
        }

        /* History List */
        .history-list {
            list-style: none;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        .history-item.gain {
            color: #008000;
        }

        .history-item.loss {
            color: #cc0000;
        }

        .tier-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-right: 0.5rem;
        }

        .tier-SSR {
            background: gold;
            color: red;
        }

        .tier-SR {
            background: #9932CC;
            color: white;
        }

        .tier-R {
            background: #00BFFF;
            color: white;
        }

        .tier-N {
            background: #eee;
            color: #555;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        @media (min-width: 400px) {
            .stats-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        .stat-box {
            background: #f9f9f9;
            padding: 0.8rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-val {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--red-primary);
        }

        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }

        /* Achievement Toast */
        .achievement-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-120px);
            opacity: 0;
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            color: #fff;
            padding: 1rem 1.25rem;
            border-radius: 16px;
            display: flex;
            align-items: center;
            gap: 1rem;
            z-index: 3000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            border: 2px solid var(--gold-primary);
            width: 90%;
            max-width: 360px;
            will-change: transform, opacity;
            transition: transform 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275),
                opacity 0.4s ease;
            pointer-events: none;
        }

        .achievement-toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .achievement-toast .icon {
            font-size: 2rem;
            min-width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 215, 0, 0.15);
            border-radius: 12px;
        }

        .achievement-toast .info {
            flex: 1;
        }

        .achievement-toast .info .title {
            font-weight: bold;
            color: var(--gold-primary);
            font-size: 0.9rem;
        }

        .achievement-toast .info .desc {
            font-size: 0.85rem;
            opacity: 0.9;
        }

        .achievement-toast .skin-unlock {
            font-size: 0.8rem;
            color: #FFD700;
            margin-top: 0.25rem;
            font-weight: bold;
            animation: pulse 1s ease-in-out infinite;
        }

        /* Info Table */
        .info-table {
            width: 100%;
            border-collapse: collapse;
        }

        .info-table th,
        .info-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        .info-table th {
            color: var(--red-primary);
        }

        /* Zodiac Selector */
        .zodiac-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
        }

        .zodiac-btn {
            background: #fff;
            border: 1px solid #ddd;
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.2s;
        }

        .zodiac-btn:hover {
            background: var(--gold-light);
            transform: scale(1.1);
        }

        .fortune-text {
            font-style: italic;
            color: var(--medical-blue);
            margin-top: 1rem;
            padding: 1rem;
            background: #f0f8ff;
            border-radius: 8px;
        }

        /* Achievement badges */
        .achievement-badge {
            width: 50px;
            height: 50px;
            background: #444;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: help;
            position: relative;
            transition: all 0.2s ease;
            border: 2px solid transparent;
        }

        .achievement-badge:hover {
            transform: scale(1.15);
            z-index: 10;
        }

        .achievement-badge .achi-icon {
            font-size: 1.5rem;
        }

        .achievement-badge .skin-indicator {
            position: absolute;
            bottom: -5px;
            right: -5px;
            font-size: 0.8rem;
            background: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* Skin-specific achievement styles */
        .achievement-badge.skin-gold {
            background: linear-gradient(135deg, #FFD700, #FDB931);
            border-color: #FFF;
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.5);
        }

        .achievement-badge.skin-holo {
            background: linear-gradient(135deg, #c0c0ff, #ffc0cb, #ffffc0, #c0ffc0);
            background-size: 200% 200%;
            animation: holoShift 3s ease infinite;
            border-color: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(192, 192, 255, 0.5);
        }

        .achievement-badge.skin-diamond {
            background: linear-gradient(135deg, #e0f7fa, #80deea);
            border-color: #FFF;
            box-shadow: 0 0 15px rgba(0, 229, 255, 0.5);
        }

        .achievement-progress {
            width: 100%;
            text-align: center;
            margin-top: 0.5rem;
            color: #666;
        }

        #achievementsList {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            align-items: center;
        }

        /* Skin Collection */
        .skin-collection {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .skin-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 0.5rem;
            border-radius: 8px;
            background: #f5f5f5;
            border: 2px solid #ddd;
            transition: all 0.2s;
        }

        .skin-item.unlocked {
            border-color: var(--gold-primary);
            background: rgba(255, 215, 0, 0.1);
        }

        .skin-preview {
            width: 40px;
            height: 50px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }

        .default-preview {
            background: linear-gradient(180deg, var(--red-primary), var(--red-dark));
            border: 2px solid var(--gold-primary);
        }

        .gold-preview {
            background: linear-gradient(135deg, #FFD700, #FDB931);
            border: 2px solid #FFF;
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .holo-preview {
            background: linear-gradient(135deg, #c0c0ff, #ffc0cb, #ffffc0);
            background-size: 200% 200%;
            animation: holoShift 3s ease infinite;
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .diamond-preview {
            background: linear-gradient(135deg, #e0f7fa, #80deea);
            border: 2px solid #FFF;
            box-shadow: 0 0 10px rgba(0, 229, 255, 0.5);
        }

        .skin-item span {
            font-size: 0.7rem;
            text-align: center;
        }

        .skin-status {
            font-size: 0.65rem !important;
            color: #999;
        }

        .skin-status.unlocked {
            color: #2e7d32;
        }

        .skin-item.locked {
            opacity: 0.6;
        }

        @media (max-width: 400px) {
            .skin-collection {
                grid-template-columns: repeat(2, 1fr);
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Mute button state */
        .icon-btn.muted {
            opacity: 0.6;
            color: #999;
            border-color: #999;
        }

        /* Reset Link */
        .reset-link {
            color: rgba(255, 255, 255, 0.4);
            font-size: 0.8rem;
            text-decoration: underline;
            cursor: pointer;
            margin-top: 0.5rem;
            display: inline-block;
        }

        .reset-link:hover {
            display: inline-block;
            color: var(--red-primary);
        }

        /* Withdraw Modal Styles - FIXED */
        .withdraw-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .form-group {
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--gold-primary);
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.2);
        }

        /* FIXED: Bank Grid with better scrolling */
        .bank-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px;
            max-height: 280px;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 8px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            background: #fafafa;
            /* Smooth scrolling */
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        /* Custom scrollbar for bank grid */
        .bank-grid::-webkit-scrollbar {
            width: 6px;
        }

        .bank-grid::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .bank-grid::-webkit-scrollbar-thumb {
            background: var(--gold-primary);
            border-radius: 3px;
        }

        .bank-grid::-webkit-scrollbar-thumb:hover {
            background: var(--gold-dark);
        }

        /* FIXED: Bank item with proper sizing and fallback */
        .bank-item {
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            padding: 10px 6px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            width: 100%;
            min-height: 70px;
            text-align: center;
            background: white;
            /* Prevent text selection on rapid clicks */
            user-select: none;
            -webkit-user-select: none;
        }

        .bank-item:hover {
            border-color: var(--gold-primary);
            background: rgba(255, 215, 0, 0.08);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .bank-item:active {
            transform: translateY(0);
        }

        .bank-item.selected {
            border: 2px solid var(--red-primary);
            background: rgba(196, 30, 58, 0.08);
            box-shadow: 0 0 0 3px rgba(196, 30, 58, 0.2);
        }

        .bank-item img {
            height: 28px;
            width: auto;
            max-width: 60px;
            object-fit: contain;
        }

        .bank-item span {
            font-size: 0.7rem;
            font-weight: 600;
            line-height: 1.2;
            color: #444;
            word-break: break-word;
            max-width: 100%;
        }

        /* Fallback for failed images */
        .bank-item.img-error {
            background: #f5f5f5;
        }

        .bank-item.img-error .bank-fallback {
            width: 28px;
            height: 28px;
            background: var(--red-primary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 0.7rem;
        }

        .withdraw-note {
            font-size: 0.8rem;
            color: #666;
            margin-top: 0.5rem;
            font-style: italic;
        }

        /* Loading state for banks */
        .bank-grid.loading {
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bank-grid.loading::after {
            content: 'ƒêang t·∫£i...';
            color: #999;
            font-style: italic;
        }

        /* ==================== TIER-SPECIFIC REVEAL ANIMATIONS ==================== */
        /* Reveal overlay for dramatic effects */
        .reveal-overlay {
            position: fixed;
            inset: 0;
            pointer-events: none;
            z-index: 1500;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .reveal-overlay.active {
            opacity: 1;
        }

        /* SSR: Golden explosion effect */
        .reveal-ssr {
            background: radial-gradient(circle at center,
                    rgba(255, 215, 0, 0.9) 0%,
                    rgba(255, 180, 0, 0.6) 30%,
                    rgba(255, 100, 0, 0.3) 60%,
                    transparent 80%);
            animation: ssrReveal 1.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .reveal-ssr::before {
            content: '‚≠ê';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0);
            font-size: 8rem;
            animation: ssrStar 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) 0.2s forwards;
            filter: drop-shadow(0 0 30px gold);
        }

        @keyframes ssrReveal {
            0% {
                opacity: 0;
                transform: scale(0.5);
            }

            20% {
                opacity: 1;
                transform: scale(1.2);
            }

            40% {
                opacity: 1;
                transform: scale(1);
            }

            100% {
                opacity: 0;
                transform: scale(1.5);
            }
        }

        @keyframes ssrStar {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(0deg);
                opacity: 0;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.5) rotate(180deg);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(0.5) rotate(360deg);
                opacity: 0;
            }
        }

        /* SR: Purple shimmer wave */
        .reveal-sr {
            background: linear-gradient(135deg,
                    rgba(138, 43, 226, 0) 0%,
                    rgba(153, 50, 204, 0.6) 50%,
                    rgba(138, 43, 226, 0) 100%);
            background-size: 300% 300%;
            animation: srShimmer 0.8s ease-out forwards;
        }

        .reveal-sr::after {
            content: '';
            position: absolute;
            inset: 0;
            background: radial-gradient(circle at center,
                    rgba(200, 100, 255, 0.4) 0%,
                    transparent 60%);
            animation: srPulse 0.6s ease-out 0.2s forwards;
        }

        @keyframes srShimmer {
            0% {
                background-position: 100% 100%;
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                background-position: 0% 0%;
                opacity: 0;
            }
        }

        @keyframes srPulse {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            50% {
                opacity: 1;
            }

            100% {
                transform: scale(2);
                opacity: 0;
            }
        }

        /* R: Blue glow effect */
        .reveal-r {
            background: radial-gradient(circle at center,
                    rgba(0, 191, 255, 0.5) 0%,
                    rgba(0, 150, 255, 0.2) 40%,
                    transparent 70%);
            animation: rGlow 0.5s ease-out forwards;
        }

        @keyframes rGlow {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0;
                transform: scale(1.3);
            }
        }

        /* Result card entrance animations per tier */
        .result-card.reveal-anim-ssr {
            animation: cardRevealSSR 0.8s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
        }

        .result-card.reveal-anim-sr {
            animation: cardRevealSR 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }

        .result-card.reveal-anim-r {
            animation: cardRevealR 0.5s ease-out forwards;
        }

        @keyframes cardRevealSSR {
            0% {
                opacity: 0;
                transform: scale(0.3) rotateY(180deg);
            }

            60% {
                transform: scale(1.1) rotateY(0deg);
            }

            100% {
                opacity: 1;
                transform: scale(1) rotateY(0deg);
            }
        }

        @keyframes cardRevealSR {
            0% {
                opacity: 0;
                transform: scale(0.5) translateY(50px);
            }

            100% {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        @keyframes cardRevealR {
            0% {
                opacity: 0;
                transform: scale(0.8);
            }

            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* ==================== LUCK METER (PITY SYSTEM) ==================== */
        .luck-meter-container {
            position: relative;
            width: 100%;
            max-width: 200px;
            margin: 1rem auto 0;
            text-align: center;
        }

        .luck-meter {
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }

        .luck-meter-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FF6B6B, #FF4444);
            border-radius: 4px;
            transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }

        .luck-meter-label {
            font-size: 0.75rem;
            color: var(--gold-light);
            margin-top: 0.3rem;
            opacity: 0.9;
        }

        .luck-meter-container.near-pity .luck-meter {
            animation: luckGlow 1s ease-in-out infinite;
        }

        .luck-meter-container.near-pity .luck-meter-label {
            color: #FF6B6B;
            font-weight: bold;
        }

        @keyframes luckGlow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(255, 100, 100, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(255, 100, 100, 0.8);
            }
        }

        /* ==================== LEADERBOARD ==================== */
        .leaderboard-container {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .leaderboard-title {
            color: var(--gold-primary);
            font-size: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            font-size: 0.85rem;
            color: #fff;
            transition: all 0.2s;
        }

        .leaderboard-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .leaderboard-item.current-user {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.2), rgba(255, 180, 0, 0.1));
            border: 1px solid var(--gold-primary);
            font-weight: bold;
        }

        .leaderboard-rank {
            min-width: 28px;
            text-align: center;
            font-weight: bold;
        }

        .leaderboard-rank.gold {
            color: #FFD700;
        }

        .leaderboard-rank.silver {
            color: #C0C0C0;
        }

        .leaderboard-rank.bronze {
            color: #CD7F32;
        }

        .leaderboard-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .leaderboard-score {
            color: var(--gold-light);
            font-weight: 600;
        }

        /* ==================== HOLOGRAPHIC CARD EFFECT ==================== */
        .money-card.holo-active {
            transform-style: preserve-3d;
            transition: transform 0.1s ease-out;
        }

        .money-card .holo-shine {
            position: absolute;
            inset: 0;
            background: linear-gradient(105deg,
                    transparent 20%,
                    rgba(255, 255, 255, 0.3) 30%,
                    rgba(255, 220, 100, 0.2) 35%,
                    rgba(100, 255, 200, 0.15) 40%,
                    rgba(200, 100, 255, 0.15) 45%,
                    rgba(255, 255, 255, 0.25) 50%,
                    transparent 60%);
            background-size: 250% 250%;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            mix-blend-mode: color-dodge;
            transition: opacity 0.3s;
        }

        /* Tier Specific Holo Effects */
        .holo-shine.SSR {
            /* Rainbow already default but reinforced */
            background: linear-gradient(105deg,
                    transparent 20%,
                    rgba(255, 0, 0, 0.2) 30%,
                    rgba(255, 255, 0, 0.2) 35%,
                    rgba(0, 255, 0, 0.2) 40%,
                    rgba(0, 255, 255, 0.2) 45%,
                    rgba(0, 0, 255, 0.2) 50%,
                    rgba(255, 0, 255, 0.2) 55%,
                    transparent 60%);
        }

        .holo-shine.SR {
            /* Gold/Amber */
            background: linear-gradient(105deg,
                    transparent 20%,
                    rgba(255, 223, 0, 0.1) 30%,
                    rgba(255, 215, 0, 0.4) 40%,
                    rgba(255, 223, 0, 0.1) 50%,
                    transparent 60%);
        }

        .holo-shine.R {
            /* Silver/Blue */
            background: linear-gradient(105deg,
                    transparent 20%,
                    rgba(255, 255, 255, 0.1) 30%,
                    rgba(200, 230, 255, 0.3) 40%,
                    rgba(255, 255, 255, 0.1) 50%,
                    transparent 60%);
        }

        /* Nothing for N (plain) */
        /* Default Holo Style (for N tier or generic) */
        .holo-shine {
            /* Rainbow/Oil slick effect */
            background: linear-gradient(105deg,
                    transparent 20%,
                    rgba(255, 0, 0, 0.2) 30%,
                    rgba(0, 255, 0, 0.2) 40%,
                    rgba(0, 0, 255, 0.2) 50%,
                    transparent 60%);
            display: block;
            /* Ensure it exists in DOM */
            opacity: 0;
            /* Hidden by default until active */
        }

        /* Specific override to show when active, using ID for higher specificity */
        #moneyStackWrapper.holo-active .holo-shine,
        .money-card.holo-active .holo-shine {
            opacity: 1 !important;
            display: block !important;
        }

        /* Desktop Hover Effect Only */
        @media (hover: hover) {
            .money-card:hover .holo-shine {
                opacity: 1 !important;
                display: block !important;
            }

            .money-card:hover {
                transform: var(--stack-transform) scale(1.05) !important;
                z-index: 10 !important;
            }
        }

        /* Enhanced Diamond Skin - Premium Holographic Rainbow */
        .envelope.skin-diamond .envelope-body {
            background: linear-gradient(135deg,
                    #ff6b6b 0%, #feca57 15%, #48dbfb 30%,
                    #ff9ff3 45%, #54a0ff 60%, #5f27cd 75%,
                    #00d2d3 90%, #ff6b6b 100%);
            background-size: 400% 400%;
            animation: diamondShift 6s ease infinite;
            border: 3px solid rgba(255, 255, 255, 0.8);
            box-shadow:
                0 0 40px rgba(255, 100, 255, 0.4),
                0 0 80px rgba(100, 200, 255, 0.2),
                inset 0 0 30px rgba(255, 255, 255, 0.3);
        }

        .envelope.skin-diamond .envelope-body::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(125deg,
                    transparent 0%,
                    rgba(255, 255, 255, 0.5) 25%,
                    transparent 50%,
                    rgba(255, 255, 255, 0.3) 75%,
                    transparent 100%);
            background-size: 200% 200%;
            animation: diamondShine 3s linear infinite;
            pointer-events: none;
            mix-blend-mode: overlay;
        }

        .envelope.skin-diamond .envelope-flap {
            background: linear-gradient(180deg,
                    #ff9ff3 0%, #54a0ff 50%, #00d2d3 100%);
            background-size: 200% 200%;
            animation: diamondShift 6s ease infinite;
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-top: none;
        }

        .envelope.skin-diamond .envelope-seal {
            background: linear-gradient(135deg, #fff, #f0f0f0, #fff);
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }

        @keyframes diamondShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        @keyframes diamondShine {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* Diamond skin preview (stats modal) */
        .diamond-preview {
            background: linear-gradient(135deg, #ff6b6b, #feca57, #48dbfb, #ff9ff3) !important;
            background-size: 300% 300% !important;
            animation: diamondShift 4s ease infinite !important;
            box-shadow: 0 0 15px rgba(255, 100, 255, 0.5) !important;
        }

        /* Tap Event Styles */
        .tap-event-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 5000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
            pointer-events: auto;
            /* Changed to auto to capture clicks on mobile */
        }

        .tap-event-overlay.active {
            display: flex;
        }

        .tap-event-content {
            text-align: center;
            color: white;
            pointer-events: none;
            width: 100%;
            max-width: 400px;
            padding: 2rem;
        }

        .tap-title {
            font-size: clamp(2rem, 8vw, 3rem);
            color: #FFD700;
            text-shadow: 0 0 20px #FF4500;
            animation: pulse-gold 0.5s infinite alternate;
            margin-bottom: 0.5rem;
        }

        .tap-subtitle {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            color: #FFF;
        }

        .tap-timer-bar {
            width: 100%;
            height: 10px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 5px;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .tap-timer-fill {
            height: 100%;
            background: linear-gradient(90deg, #FFD700, #FF4500);
            width: 100%;
            transform-origin: left;
        }

        .tap-counter {
            font-size: 2rem;
            font-weight: bold;
            color: #00E676;
        }

        /* Shake Harder Animation */
        @keyframes shake-extreme {

            0%,
            100% {
                transform: translate(0, 0) rotate(0deg);
            }

            10% {
                transform: translate(-15px, -15px) rotate(-10deg);
            }

            30% {
                transform: translate(15px, 15px) rotate(10deg);
            }

            50% {
                transform: translate(-10px, -10px) rotate(-5deg);
            }

            70% {
                transform: translate(10px, 10px) rotate(5deg);
            }
        }

        .envelope.shake-extreme {
            animation: shake-extreme 0.2s ease-in-out infinite;
        }
    </style>
</head>

<body>
    <div class="lucky-particles" id="particles"></div>
    <div class="confetti-container" id="confetti"></div>
    <div class="jackpot-overlay"></div>

    <!-- Random Event Overlay -->
    <div id="tapEventOverlay" class="tap-event-overlay" onclick="handleTapEventClick()">
        <div class="tap-event-content">
            <h2 class="tap-title">üî• B√ôNG N·ªî V·∫¨N MAY! üî•</h2>
            <p class="tap-subtitle">Ch·∫°m nhanh ƒë·ªÉ tƒÉng t·ª∑ l·ªá n·ªï h≈©!</p>
            <div class="tap-timer-bar">
                <div class="tap-timer-fill" id="tapTimerFill"></div>
            </div>
            <div class="tap-counter">T·ª∑ l·ªá: <span id="tapLuckDisplay">+0%</span></div>
        </div>
    </div>

    <!-- Tier Reveal Overlay -->
    <div class="reveal-overlay" id="revealOverlay"></div>

    <!-- Share Button -->
    <div class="share-btn" onclick="showShareModal()">
        üîó
    </div>

    <!-- Share Modal -->
    <div class="share-modal-overlay" id="shareModal" onclick="if(event.target === this) hideShareModal()">
        <div class="share-modal">
            <div class="close-modal" onclick="hideShareModal()">√ó</div>
            <h3
                style="color: var(--red-primary); font-size: 1.5rem; margin-bottom: 0.5rem; font-family: 'Playfair Display', serif;">
                Chia S·∫ª May M·∫Øn</h3>
            <p style="color: #666; font-size: 0.9rem;">Qu√©t m√£ QR ƒë·ªÉ nh·∫≠n l√¨ x√¨ ngay!</p>

            <div class="qr-container" id="qrcode"></div>

            <p id="shareUrl"
                style="font-size: 0.8rem; color: #999; word-break: break-all; margin-bottom: 1rem; display: none;"></p>

            <div class="share-actions">
                <button class="share-action-btn btn-copy" onclick="copyLink()">
                    üìã Sao ch√©p
                </button>
                <button class="share-action-btn btn-download" onclick="downloadQR()">
                    ‚¨áÔ∏è T·∫£i QR
                </button>
            </div>
        </div>
    </div>

    <!-- Utility Buttons (includes sound control) -->
    <div class="utility-bar">
        <button class="icon-btn" id="muteBtn" onclick="toggleMute()">üîä</button>
        <button class="icon-btn" onclick="openStats()">üìä</button>
        <button class="icon-btn" onclick="openInfo()">‚ÑπÔ∏è</button>
    </div>

    <!-- Stats Modal -->
    <div class="modal-overlay" id="statsModal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div>Th·ªëng K√™ & L·ªãch S·ª≠</div>
                <button class="close-btn" onclick="closeModal('statsModal')">√ó</button>
            </div>
            <div class="modal-body">
                <!-- Stats Grid -->
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-val" id="statTotalPulls">0</div>
                        <div class="stat-label">L·∫ßn m·ªü</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val" id="statSSRCount">0</div>
                        <div class="stat-label">SSR üåü</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val" id="statSRCount">0</div>
                        <div class="stat-label">SR üíú</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-val" id="statGambleWins">0</div>
                        <div class="stat-label">Th·∫Øng c∆∞·ª£c üé∞</div>
                    </div>
                </div>

                <!-- Skin Progress -->
                <h3
                    style="margin: 1rem 0; color: var(--red-dark); border-bottom: 2px solid var(--gold-primary); display: inline-block;">
                    B·ªô S∆∞u T·∫≠p Skin üé®</h3>
                <div class="skin-collection" id="skinCollection">
                    <div class="skin-item" data-skin="default">
                        <div class="skin-preview default-preview">üßß</div>
                        <span>M·∫∑c ƒë·ªãnh</span>
                        <span class="skin-status unlocked">‚úì</span>
                    </div>
                    <div class="skin-item" data-skin="gold" id="skinGold">
                        <div class="skin-preview gold-preview">üßß</div>
                        <span>V√†ng</span>
                        <span class="skin-status locked">üîí 1M</span>
                    </div>
                    <div class="skin-item" data-skin="holo" id="skinHolo">
                        <div class="skin-preview holo-preview">üßß</div>
                        <span>Hologram</span>
                        <span class="skin-status locked">üîí 5M</span>
                    </div>
                    <div class="skin-item" data-skin="diamond" id="skinDiamond">
                        <div class="skin-preview diamond-preview">üßß</div>
                        <span>Kim C∆∞∆°ng</span>
                        <span class="skin-status locked">üîí 10M</span>
                    </div>
                </div>

                <h3
                    style="margin: 1rem 0; color: var(--red-dark); border-bottom: 2px solid var(--gold-primary); display: inline-block;">
                    Th√†nh T·ª±u üèÜ</h3>
                <div id="achievementsList">
                </div>

                <!-- Leaderboard -->
                <h3
                    style="margin: 1rem 0; color: var(--red-dark); border-bottom: 2px solid var(--gold-primary); display: inline-block;">
                    B·∫£ng X·∫øp H·∫°ng üèÖ</h3>
                <div class="leaderboard-container" id="leaderboardContainer">
                    <div class="leaderboard-list" id="leaderboardList">
                        <!-- Rendered by JS -->
                    </div>
                </div>

                <h3 id="yearTitle"
                    style="margin: 1rem 0; color: var(--red-dark); border-bottom: 2px solid var(--gold-primary); display: inline-block;">
                    NƒÉm M·ªõi B√≠nh Ng·ªç üîÆ</h3>
                <div id="zodiacSection">
                    <div class="zodiac-grid" id="zodiacGrid">
                    </div>
                    <div id="fortuneResult" class="fortune-text" style="display: none;"></div>
                </div>

                <h3
                    style="margin: 1rem 0; color: var(--red-dark); border-bottom: 2px solid var(--gold-primary); display: inline-block;">
                    L·ªãch S·ª≠ G·∫ßn ƒê√¢y üìú</h3>
                <ul class="history-list" id="historyList">
                </ul>
            </div>
        </div>
    </div>

    <!-- Info Modal -->
    <div class="modal-overlay" id="infoModal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div>T·ª∑ L·ªá R∆°i & Th√¥ng Tin</div>
                <button class="close-btn" onclick="closeModal('infoModal')">√ó</button>
            </div>
            <div class="modal-body">
                <table class="info-table">
                    <tr>
                        <th>H·∫°ng (Tier)</th>
                        <th>T·ª∑ L·ªá</th>
                        <th>Ph·∫ßn Th∆∞·ªüng</th>
                    </tr>
                    <tr style="background: rgba(255, 215, 0, 0.2)">
                        <td><strong>SSR</strong></td>
                        <td>5%</td>
                        <td>500.000 VNƒê</td>
                    </tr>
                    <tr style="background: rgba(153, 50, 204, 0.1)">
                        <td><strong>SR</strong></td>
                        <td>20%</td>
                        <td>200.000 VNƒê</td>
                    </tr>
                    <tr style="background: rgba(0, 191, 255, 0.1)">
                        <td><strong>R</strong></td>
                        <td>35%</td>
                        <td>50k - 100k</td>
                    </tr>
                    <tr>
                        <td><strong>N</strong></td>
                        <td>40%</td>
                        <td>10k - 20k</td>
                    </tr>
                </table>
                <p style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                    * Skin V√†ng m·ªü kh√≥a khi ƒë·∫°t 1 Tri·ªáu.<br>
                    * Skin Hologram m·ªü kh√≥a khi ƒë·∫°t 5 Tri·ªáu.<br>
                    * Skin Kim C∆∞∆°ng m·ªü kh√≥a khi ƒë·∫°t 10 Tri·ªáu.
                </p>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal - FIXED -->
    <div class="modal-overlay" id="withdrawModal">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div>R√∫t Ti·ªÅn V·ªÅ T√†i Kho·∫£n</div>
                <button class="close-btn" onclick="closeModal('withdrawModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="withdraw-form">
                    <div class="form-group">
                        <label>S·ªë Ti·ªÅn R√∫t</label>
                        <div class="form-input"
                            style="background: #f5f5f5; color: var(--red-primary); font-weight: bold;"
                            id="withdrawAmountDisplay">0 VNƒê</div>
                    </div>

                    <div class="form-group">
                        <label>S·ªë T√†i Kho·∫£n (STK)</label>
                        <input type="text" class="form-input" id="stkInput" placeholder="Nh·∫≠p s·ªë t√†i kho·∫£n..."
                            value="0123456789">
                    </div>

                    <div class="form-group">
                        <label>Ch·ªçn Ng√¢n H√†ng</label>
                        <div class="bank-grid" id="bankGrid">
                            <!-- Banks will be rendered here -->
                        </div>
                    </div>

                    <button class="btn btn-primary" id="confirmWithdrawBtn"
                        style="width: 100%; max-width: 100%; margin-top: 0.5rem;" onclick="confirmWithdraw()">
                        üí∏ R√∫t Ngay
                    </button>

                    <p class="withdraw-note">* Ti·ªÅn s·∫Ω v·ªÅ t√†i kho·∫£n trong gi√¢y l√°t</p>
                </div>
            </div>
        </div>
    </div>

    <svg class="ecg-line" viewBox="0 0 500 100" preserveAspectRatio="none">
        <path class="ecg-path" d="M0,50 L50,50 L60,20 L70,80 L80,50 L400,50 L410,20 L420,80 L430,50 L500,50" />
    </svg>

    <div class="wallet-container">
        <div class="wallet-icon">üí∞</div>
        <div class="wallet-balance" id="walletBalance">0</div>
        <div class="wallet-currency">VNƒê</div>
        <button class="withdraw-btn" onclick="openWithdrawModal('wallet')">R√∫t</button>
    </div>

    <div class="container">
        <header class="header">
            <h1>üßß L√¨ X√¨ May M·∫Øn</h1>
            <p>Ch√∫c M·ª´ng NƒÉm M·ªõi 2026 - Xu√¢n B√≠nh Ng·ªç üêé</p>
            <div class="department-badge">üè• Ph√≤ng CNTT - B·ªánh Vi·ªán ƒêa Khoa Ho√†n M·ªπ S√†i G√≤n</div>
        </header>

        <div class="envelope-container" id="envelopeContainer">
            <div class="envelope" id="envelope">
                <div class="envelope-flap"></div>
                <div class="envelope-seal">üßß</div>
                <div class="envelope-body">
                    <div class="envelope-pattern"></div>
                </div>
            </div>
        </div>

        <p class="click-hint" id="clickHint">üëÜ Nh·∫•n ho·∫∑c L·∫Øc ƒëi·ªán tho·∫°i üì≥ ƒë·ªÉ m·ªü</p>

        <!-- Luck Meter (Pity System) -->
        <div class="luck-meter-container" id="luckMeterContainer">
            <div class="luck-meter">
                <div class="luck-meter-fill" id="luckMeterFill" style="width: 0%"></div>
            </div>
            <div class="luck-meter-label" id="luckMeterLabel">üî• V·∫≠n may: 0/25</div>
        </div>

        <div class="result-card" id="resultCard">
            <div class="amount" id="amount">0</div>
            <div class="currency">VNƒê</div>

            <div class="money-display">
                <div class="money-stack-container" id="moneyStackContainer">
                    <div class="money-stack-wrapper" id="moneyStackWrapper">
                        <div class="money-card" id="moneyCard">
                            <div class="money-face money-front">
                                <img id="moneyFront" src="" alt="M·∫∑t tr∆∞·ªõc">
                            </div>
                            <div class="money-face money-back">
                                <img id="moneyBack" src="" alt="M·∫∑t sau">
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <div class="wish" id="wish"></div>

            <div class="buttons">
                <button class="btn btn-primary" onclick="resetEnvelope()">
                    üîÑ Th·ª≠ L·∫°i
                </button>
                <button class="btn btn-secondary" id="actionWithdrawBtn" onclick="openWithdrawModal('current')">
                    üí∏ R√∫t Ti·ªÅn
                </button>
                <button class="btn btn-danger" id="gambleBtn" onclick="gambleAll()">
                    üé≤ C∆∞·ª£c T·∫•t Tay
                </button>
            </div>
        </div>

        <footer class="footer">
            <p>Made with ‚ù§Ô∏è by HuyPG ‚Ä¢ T·∫øt 2026</p>
            <div class="reset-link" onclick="resetData()">X√≥a d·ªØ li·ªáu & Ch∆°i l·∫°i</div>
        </footer>
    </div>

    <script>
        // ==================== GLOBAL STATE ====================
        let withdrawMode = 'current';
        let pendingAmount = 0;
        let selectedBank = 'VCB';
        let isOpened = false;
        let currentResult = null;
        let isMuted = false; // Will be initialized in init()
        let banksRendered = false; // Track if banks are rendered
        let scrollPosition = 0; // Store scroll position for no-scroll fix

        // ==================== DATA ====================
        const moneyAmounts = [
            { value: 10000, display: '10.000', front: 'images/10k-1.jpg', back: 'images/10k-2.jpg' },
            { value: 20000, display: '20.000', front: 'images/20k-1.jpg', back: 'images/20k-2.jpg' },
            { value: 50000, display: '50.000', front: 'images/50k-1.jpg', back: 'images/50k-2.jpg' },
            { value: 100000, display: '100.000', front: 'images/100k-1.jpg', back: 'images/100k-2.jpg' },
            { value: 200000, display: '200.000', front: 'images/200k-1.jpg', back: 'images/200k-2.jpg' },
            { value: 500000, display: '500.000', front: 'images/500k-1.jpg', back: 'images/500k-2.jpg' }
        ];

        const BANKS_DATA = [
            { "code": "ABB", "name": "ABBANK" },
            { "code": "ACB", "name": "ACB" },
            { "code": "VBA", "name": "Agribank" },
            { "code": "BAB", "name": "BacABank" },
            { "code": "BVB", "name": "BaoVietBank" },
            { "code": "BIDV", "name": "BIDV" },
            { "code": "CAKE", "name": "CAKE" },
            { "code": "CBB", "name": "CBBank" },
            { "code": "CIMB", "name": "CIMB" },
            { "code": "COOPBANK", "name": "COOPBANK" },
            { "code": "EIB", "name": "Eximbank" },
            { "code": "HDB", "name": "HDBank" },
            { "code": "HSBC", "name": "HSBC" },
            { "code": "KLB", "name": "KienLongBank" },
            { "code": "LPB", "name": "LPBank" },
            { "code": "MB", "name": "MBBank" },
            { "code": "MSB", "name": "MSB" },
            { "code": "NAB", "name": "NamABank" },
            { "code": "NCB", "name": "NCB" },
            { "code": "OCB", "name": "OCB" },
            { "code": "PGB", "name": "PGBank" },
            { "code": "PVCB", "name": "PVcomBank" },
            { "code": "STB", "name": "Sacombank" },
            { "code": "SGICB", "name": "SaigonBank" },
            { "code": "SCB", "name": "SCB" },
            { "code": "SEAB", "name": "SeABank" },
            { "code": "SHB", "name": "SHB" },
            { "code": "SHBVN", "name": "ShinhanBank" },
            { "code": "TCB", "name": "Techcombank" },
            { "code": "TIMO", "name": "Timo" },
            { "code": "TPB", "name": "TPBank" },
            { "code": "Ubank", "name": "Ubank" },
            { "code": "VAB", "name": "VietABank" },
            { "code": "VCCB", "name": "VietCapitalBank" },
            { "code": "VIETBANK", "name": "VietBank" },
            { "code": "VCB", "name": "Vietcombank" },
            { "code": "ICB", "name": "VietinBank" },
            { "code": "VIB", "name": "VIB" },
            { "code": "VPB", "name": "VPBank" },
            { "code": "VRB", "name": "VRB" }
        ];

        // Wishes
        const wishesIT = [
            "H·ªá th·ªëng HIS v·∫≠n h√†nh tr∆°n tru, kh√¥ng ticket n√†o treo! üè•",
            "PACS load h√¨nh si√™u t·ªëc, b√°c sƒ© khen n·ª©c n·ªü! ‚ö°",
            "Server uptime 100%, tr·ª±c T·∫øt nh√†n t√™nh! üñ•Ô∏è",
            "M·∫°ng b·ªánh vi·ªán m·∫°nh nh∆∞ r·ªìng, VPN kh√¥ng bao gi·ªù r·ªõt! üêâ",
            "M√°y in ho·∫°t ƒë·ªông √™m √°i, gi·∫•y kh√¥ng bao gi·ªù k·∫πt! üñ®Ô∏è",
            "C√°c khoa ph√≤ng vui v·∫ª, y√™u th∆∞∆°ng ƒë·ªôi IT! ‚ù§Ô∏è",
            "Code b·ªánh √°n ƒëi·ªán t·ª≠ kh√¥ng bug, data chu·∫©n ch·ªâ! üìä",
            "L∆∞∆°ng th∆∞·ªüng ng·∫≠p tr√†n, s·ª©c kh·ªèe d·ªìi d√†o nh∆∞ thanh RAM 64GB! üí™",
            "NƒÉm m·ªõi fix bug nhanh h∆°n b√°c sƒ© ch·∫©n ƒëo√°n! ü©∫",
            "An to√†n th√¥ng tin v·ªØng ch√£i, virus/ransomware tr√°nh xa! üõ°Ô∏è"
        ];

        const wishesGeneral = [
            "An khang th·ªãnh v∆∞·ª£ng - V·∫°n s·ª± nh∆∞ √Ω! üå∏",
            "T·∫•n t√†i t·∫•n l·ªôc - M√£ ƒë√°o th√†nh c√¥ng! üßß",
            "S·ª©c kh·ªèe d·ªìi d√†o, ti·ªÅn v√†o nh∆∞ n∆∞·ªõc! üí∞",
            "NƒÉm m·ªõi b√¨nh an, h·∫°nh ph√∫c tr√†n ƒë·∫ßy! ‚ù§Ô∏è",
            "C√¥ng vi·ªác thu·∫≠n l·ª£i, thƒÉng ti·∫øn v√π v√π! üöÄ"
        ];

        let wishes = wishesIT;
        let wishDeck = [];

        // Audio
        const sounds = {
            open: new Audio('sounds/318636225-gacha-ready.m4a'),
            coin: new Audio('sounds/318636226-gacha-start.m4a'),
            ssr: new Audio('sounds/318636226-gacha-start.m4a'),
            sr: new Audio('sounds/318636226-gacha-start.m4a')
        };
        Object.values(sounds).forEach(s => s.volume = 0.4);

        // ==================== DOM ELEMENTS ====================
        const envelope = document.getElementById('envelope');
        const envelopeContainer = document.getElementById('envelopeContainer');
        const clickHint = document.getElementById('clickHint');
        const resultCard = document.getElementById('resultCard');
        const amountEl = document.getElementById('amount');
        const wishEl = document.getElementById('wish');
        const walletEl = document.getElementById('walletBalance');
        const walletContainer = document.querySelector('.wallet-container');
        const muteBtn = document.getElementById('muteBtn');

        // ==================== UTILITY FUNCTIONS ====================
        function formatNumber(num) {
            if (num === null || num === undefined || isNaN(num)) return '0';
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, '.');
        }

        function getRandomItem(arr) {
            return arr[Math.floor(Math.random() * arr.length)];
        }

        function getNextWish() {
            if (wishDeck.length === 0) {
                wishDeck = [...wishes];
                for (let i = wishDeck.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [wishDeck[i], wishDeck[j]] = [wishDeck[j], wishDeck[i]];
                }
            }
            return wishDeck.pop();
        }

        function playSound(name) {
            if (isMuted) return;
            try {
                sounds[name].currentTime = 0;
                sounds[name].play().catch(e => { });
            } catch (err) { }
        }

        // ==================== SAFE STORAGE ====================
        const Storage = {
            get(key) {
                try {
                    return localStorage.getItem(key);
                } catch (e) {
                    console.warn('localStorage not available:', e);
                    return null;
                }
            },
            set(key, value) {
                try {
                    localStorage.setItem(key, value);
                    return true;
                } catch (e) {
                    console.warn('localStorage not available:', e);
                    return false;
                }
            },
            remove(key) {
                try {
                    localStorage.removeItem(key);
                } catch (e) {
                    console.warn('localStorage not available:', e);
                }
            }
        };

        // ==================== DATA MANAGER ====================
        const DEFAULT_DATA = {
            totalMoney: 0,
            history: [],
            stats: {
                totalPulls: 0,
                tierCounts: { SSR: 0, SR: 0, R: 0, N: 0 },
                consecutiveN: 0,
                consecutiveLosses: 0,
                gambleWins: 0,
                totalWithdrawn: 0,
                hitZero: false,
                pityCounter: 0  // Tracks pulls since last SSR for pity system
            },
            achievements: [],
            maxBalance: 0
        };

        function getData() {
            const stored = Storage.get('luckyMoneyData_v2') || Storage.get('luckyMoney_data');
            if (!stored) return { ...DEFAULT_DATA };
            try {
                const data = { ...DEFAULT_DATA, ...JSON.parse(stored) };
                if (!data.history) data.history = [];
                if (typeof data.maxBalance === 'undefined') data.maxBalance = data.totalMoney || 0;
                return data;
            } catch (e) {
                console.warn('Failed to parse saved data:', e);
                return { ...DEFAULT_DATA };
            }
        }

        function saveData(data) {
            if (data.totalMoney > (data.maxBalance || 0)) {
                data.maxBalance = data.totalMoney;
            }
            Storage.set('luckyMoneyData_v2', JSON.stringify(data));
            updateWalletDisplay();
        }

        function updateWalletDisplay() {
            const data = getData();
            walletEl.textContent = formatNumber(data.totalMoney);
        }

        function addToWallet(amount) {
            const data = getData();
            data.totalMoney += amount;
            saveData(data);
            walletContainer.classList.add('update');
            setTimeout(() => walletContainer.classList.remove('update'), 300);
            checkAchievements(data);
        }

        function addToHistory(entry) {
            const data = getData();
            data.history.unshift(entry);
            if (data.history.length > 50) data.history = data.history.slice(0, 50);
            saveData(data);
        }

        function updateStats(tier, amount) {
            const data = getData();
            data.stats.totalPulls++;
            data.stats.tierCounts[tier] = (data.stats.tierCounts[tier] || 0) + 1;
            if (tier === 'N') {
                data.stats.consecutiveN = (data.stats.consecutiveN || 0) + 1;
            } else {
                data.stats.consecutiveN = 0;
            }
            saveData(data);
            checkAchievements(data);
        }

        // ==================== MODAL FUNCTIONS - FIXED ====================
        function openModal(id) {
            // Store scroll position before locking
            scrollPosition = window.pageYOffset;
            document.body.style.top = `-${scrollPosition}px`;
            document.body.classList.add('no-scroll');
            document.getElementById(id).classList.add('open');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('open');
            document.body.classList.remove('no-scroll');
            document.body.style.top = '';
            // Restore scroll position
            window.scrollTo(0, scrollPosition);
        }

        // Click on overlay to close (not on content)
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', function (e) {
                // Only close if clicking directly on the overlay, not its children
                if (e.target === this) {
                    closeModal(this.id);
                }
            });
        });

        // ESC key to close any open modal
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                const openModal = document.querySelector('.modal-overlay.open');
                if (openModal) {
                    closeModal(openModal.id);
                }
                // Also close share modal
                const shareModal = document.getElementById('shareModal');
                if (shareModal && shareModal.style.display === 'flex') {
                    hideShareModal();
                }
            }
        });

        // ==================== BANK MODAL - FIXED ====================
        function renderBanks() {
            const grid = document.getElementById('bankGrid');

            // Don't re-render if already done
            if (banksRendered && grid.children.length > 0) {
                // Just update selection state
                updateBankSelection();
                return;
            }

            grid.innerHTML = '';
            const fragment = document.createDocumentFragment();

            BANKS_DATA.forEach(bank => {
                const div = document.createElement('div');
                div.className = `bank-item ${bank.code === selectedBank ? 'selected' : ''}`;
                div.dataset.code = bank.code;

                // Create image with error handling
                const img = document.createElement('img');
                img.src = `images/banks/${bank.code}.png`;
                img.alt = bank.name;
                img.loading = 'lazy'; // Lazy load for performance

                // Handle image load error - show fallback instead of hiding
                img.onerror = function () {
                    this.style.display = 'none';
                    const fallback = document.createElement('div');
                    fallback.className = 'bank-fallback';
                    fallback.textContent = bank.code.substring(0, 3);
                    div.insertBefore(fallback, div.firstChild);
                    div.classList.add('img-error');
                };

                const name = document.createElement('span');
                name.textContent = bank.name;

                div.appendChild(img);
                div.appendChild(name);

                // Click handler
                div.addEventListener('click', function (e) {
                    e.stopPropagation(); // Prevent event bubbling
                    selectBank(bank.code);
                });

                fragment.appendChild(div);
            });

            grid.appendChild(fragment);
            banksRendered = true;
        }

        function updateBankSelection() {
            document.querySelectorAll('.bank-item').forEach(item => {
                if (item.dataset.code === selectedBank) {
                    item.classList.add('selected');
                } else {
                    item.classList.remove('selected');
                }
            });
        }

        function selectBank(code) {
            selectedBank = code;
            updateBankSelection();
        }

        function openWithdrawModal(mode) {
            withdrawMode = mode;
            const data = getData();

            if (mode === 'current') {
                if (!currentResult || currentResult.totalValue <= 0) {
                    alert('Kh√¥ng c√≥ ti·ªÅn ƒë·ªÉ r√∫t!');
                    return;
                }
                pendingAmount = currentResult.totalValue;
            } else {
                if (data.totalMoney <= 0) {
                    alert('V√≠ c·ªßa b·∫°n ƒëang tr·ªëng!');
                    return;
                }
                pendingAmount = data.totalMoney;
            }

            if (data.totalMoney < pendingAmount) {
                alert('S·ªë d∆∞ th·ª±c t·∫ø kh√¥ng ƒë·ªß!');
                return;
            }

            document.getElementById('withdrawAmountDisplay').textContent = formatNumber(pendingAmount) + ' VNƒê';

            openModal('withdrawModal');

            // Render banks after modal is visible for better UX
            requestAnimationFrame(() => {
                renderBanks();
            });
        }

        let isProcessingWithdraw = false;

        function confirmWithdraw() {
            if (isProcessingWithdraw) return;

            const stk = document.getElementById('stkInput').value;
            if (!stk) {
                alert('Vui l√≤ng nh·∫≠p s·ªë t√†i kho·∫£n!');
                return;
            }

            const data = getData();
            if (data.totalMoney < pendingAmount) {
                alert('S·ªë d∆∞ kh√¥ng ƒë·ªß!');
                return;
            }

            isProcessingWithdraw = true;
            const withdrawButton = document.getElementById('confirmWithdrawBtn');
            if (withdrawButton) withdrawButton.disabled = true;

            closeModal('withdrawModal');
            addToWallet(-pendingAmount);

            // Track withdrawal stats
            const updatedData = getData();
            updatedData.stats.totalWithdrawn = (updatedData.stats.totalWithdrawn || 0) + pendingAmount;
            saveData(updatedData);
            checkAchievements(updatedData);

            if (withdrawMode === 'current') {
                const wBtn = document.getElementById('actionWithdrawBtn');
                if (wBtn) {
                    wBtn.disabled = true;
                    wBtn.textContent = '‚úÖ ƒê√£ R√∫t';
                }
                const gBtn = document.getElementById('gambleBtn');
                if (gBtn) gBtn.disabled = true;
            }

            // Fake notification
            const now = new Date();
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');

            const fakeBalance = 124500000 + pendingAmount;
            const maskedStk = stk.length > 4 ? stk.slice(0, 4) + 'xxxxx' : stk + 'xxxxx';
            const msg = `TK ${maskedStk} +${formatNumber(pendingAmount)}VND ${hours}:${minutes} ${day}/${month}. SD: ${formatNumber(fakeBalance)}VND. ND: Rut tien li xi`;

            setTimeout(() => {
                showFakeNotification(selectedBank, msg, 'b√¢y gi·ªù', selectedBank);
                playSound('coin');
                vibrate(100);
                isProcessingWithdraw = false;
                if (withdrawButton) withdrawButton.disabled = false;
            }, 1000);
        }

        // ==================== STATS MODAL ====================
        function openStats() {
            openModal('statsModal');
            renderStats();
            renderLeaderboard();
            renderHistory();
            renderAchievements();
            renderZodiac();
            renderSkinCollection();
        }

        function renderSkinCollection() {
            const data = getData();
            const achievements = data.achievements || [];

            // Update skin items based on achievements
            const skinGold = document.getElementById('skinGold');
            const skinHolo = document.getElementById('skinHolo');
            const skinDiamond = document.getElementById('skinDiamond');

            if (achievements.includes('millionaire')) {
                skinGold.classList.add('unlocked');
                skinGold.classList.remove('locked');
                skinGold.querySelector('.skin-status').textContent = '‚úì';
                skinGold.querySelector('.skin-status').classList.add('unlocked');
            }

            if (achievements.includes('five_million')) {
                skinHolo.classList.add('unlocked');
                skinHolo.classList.remove('locked');
                skinHolo.querySelector('.skin-status').textContent = '‚úì';
                skinHolo.querySelector('.skin-status').classList.add('unlocked');
            }

            if (achievements.includes('multimillionaire')) {
                skinDiamond.classList.add('unlocked');
                skinDiamond.classList.remove('locked');
                skinDiamond.querySelector('.skin-status').textContent = '‚úì';
                skinDiamond.querySelector('.skin-status').classList.add('unlocked');
            }
        }

        function openInfo() {
            openModal('infoModal');
        }

        function renderStats() {
            const data = getData();
            const s = data.stats;

            document.getElementById('statTotalPulls').textContent = s.totalPulls || 0;
            document.getElementById('statSSRCount').textContent = s.tierCounts?.SSR || 0;

            // Update additional stats if elements exist
            const srEl = document.getElementById('statSRCount');
            if (srEl) srEl.textContent = s.tierCounts?.SR || 0;

            const winsEl = document.getElementById('statGambleWins');
            if (winsEl) winsEl.textContent = s.gambleWins || 0;

            const withdrawnEl = document.getElementById('statWithdrawn');
            if (withdrawnEl) withdrawnEl.textContent = formatNumber(s.totalWithdrawn || 0);
        }

        function renderHistory() {
            const data = getData();
            const list = document.getElementById('historyList');
            list.innerHTML = '';

            if (data.history.length === 0) {
                list.innerHTML = '<li style="color:#888;font-style:italic;padding:1rem 0;">Ch∆∞a c√≥ l·ªãch s·ª≠...</li>';
                return;
            }

            const fragment = document.createDocumentFragment();
            data.history.forEach(item => {
                const li = document.createElement('li');
                li.className = 'history-item';
                if (item.action === 'gamble') {
                    li.classList.add(item.amount > 0 ? 'gain' : 'loss');
                }
                const timeStr = new Date(item.timestamp).toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                const tierClass = item.tier.includes('GAMBLE') ? 'tier-SSR' : `tier-${item.tier}`;
                li.innerHTML = `
                    <span><span class="tier-badge ${tierClass}">${item.tier}</span> ${timeStr}</span>
                    <span>${item.amount > 0 ? '+' : ''}${formatNumber(item.amount)}</span>
                `;
                fragment.appendChild(li);
            });
            list.appendChild(fragment);
        }

        // ==================== LEADERBOARD SYSTEM ====================
        const FUNNY_NAMES = [
            "Anh Hai L√∫a üåæ", "C√¥ Ba S√†i G√≤n üíÉ", "Ch√∫ T∆∞ ƒê·∫°i Gia üíé",
            "B√† NƒÉm V√†ng üèÜ", "√îng S√°u SSR üåü", "Em B√© Lucky üçÄ",
            "Th·∫ßn T√†i Online üí∞", "Vua L√¨ X√¨ üßß", "Th√°nh May M·∫Øn ‚ú®",
            "ƒê·∫°i Ca Jackpot üé∞", "N·ªØ Ho√†ng ƒê·ªè üëë", "Chi·∫øn Th·∫ßn Gacha ‚öîÔ∏è",
            "Ph√∫ √îng 4.0 üì±", "C·∫≠u V√†ng 999 ü•á", "Ch·ªã ƒê·∫πp Gi√†u Sang üíÖ",
            "B√°c T√°m H√™n Xui üé≤", "C√¥ Ch√≠n Ph√°t T√†i üî•", "Anh M∆∞·ªùi T·ª∑ üíµ",
            "Th√°nh R√∫t Ti·ªÅn üèß", "Cao Th·ªß L·∫Øc üì≥", "Si√™u Nh√¢n May ü¶∏",
            "Boss Cu·ªëi NƒÉm üêâ", "Vip Kim C∆∞∆°ng üí†", "ƒê·ªá Nh·∫•t H√™n üåà",
            "Ho√†ng T·ª≠ ƒê·ªè üî¥", "C√¥ng Ch√∫a V√†ng üë∏", "T·ª∑ Ph√∫ T·∫øt üéä",
            "Th·∫ßn R·ªìng Ph√°t üê≤", "Ph∆∞·ª£ng Ho√†ng L·ª≠a üî•", "K·ª≥ L√¢n May M·∫Øn ü¶Ñ"
        ];

        function generateLeaderboard() {
            const data = getData();
            const userScore = data.maxBalance || data.totalMoney || 0;

            // Generate AI players with varied scores
            const aiPlayers = [];
            const scoreRanges = [
                { min: 50000000, max: 100000000 },  // Top tier
                { min: 20000000, max: 50000000 },   // High
                { min: 10000000, max: 20000000 },   // Mid-high
                { min: 5000000, max: 10000000 },    // Mid
                { min: 2000000, max: 5000000 },     // Mid-low
                { min: 1000000, max: 2000000 },     // Low
                { min: 500000, max: 1000000 },      // Very low
                { min: 200000, max: 500000 },       // Starter
                { min: 50000, max: 200000 },        // Beginner
            ];

            // Pick 9 random unique names
            const shuffledNames = [...FUNNY_NAMES].sort(() => Math.random() - 0.5);
            for (let i = 0; i < 9; i++) {
                const range = scoreRanges[i] || scoreRanges[scoreRanges.length - 1];
                aiPlayers.push({
                    name: shuffledNames[i],
                    score: Math.floor(Math.random() * (range.max - range.min) + range.min),
                    isUser: false
                });
            }

            // Add current user
            aiPlayers.push({
                name: "üë§ B·∫°n",
                score: userScore,
                isUser: true
            });

            // Sort by score descending
            aiPlayers.sort((a, b) => b.score - a.score);

            return aiPlayers.slice(0, 10);  // Top 10
        }

        function renderLeaderboard() {
            const list = document.getElementById('leaderboardList');
            if (!list) return;

            const leaderboard = generateLeaderboard();
            list.innerHTML = '';

            leaderboard.forEach((player, idx) => {
                const rank = idx + 1;
                let rankClass = '';
                let rankIcon = rank;

                if (rank === 1) { rankClass = 'gold'; rankIcon = 'ü•á'; }
                else if (rank === 2) { rankClass = 'silver'; rankIcon = 'ü•à'; }
                else if (rank === 3) { rankClass = 'bronze'; rankIcon = 'ü•â'; }

                const item = document.createElement('div');
                item.className = `leaderboard-item ${player.isUser ? 'current-user' : ''}`;
                item.innerHTML = `
                    <span class="leaderboard-rank ${rankClass}">${rankIcon}</span>
                    <span class="leaderboard-name">${player.name}</span>
                    <span class="leaderboard-score">${formatNumber(player.score)}</span>
                `;
                list.appendChild(item);
            });
        }

        // ==================== LUCK METER (PITY SYSTEM) ====================
        const PITY_THRESHOLD = 25;      // Guaranteed SSR at this count
        const SOFT_PITY_START = 20;     // Bonus rate starts here
        const SOFT_PITY_BONUS = 0.03;   // +3% per pull after soft pity
        const BASE_SSR_RATE = 3;        // Base 3% SSR rate

        function updateLuckMeter() {
            const data = getData();
            const pity = data.stats.pityCounter || 0;
            const percentage = Math.min((pity / PITY_THRESHOLD) * 100, 100);

            const fill = document.getElementById('luckMeterFill');
            const label = document.getElementById('luckMeterLabel');
            const container = document.getElementById('luckMeterContainer');

            if (fill) fill.style.width = `${percentage}%`;
            if (label) {
                if (pity >= SOFT_PITY_START) {
                    label.textContent = `üî• V·∫≠n may: ${pity}/${PITY_THRESHOLD} (S·∫Øp SSR!)`;
                } else {
                    label.textContent = `üî• V·∫≠n may: ${pity}/${PITY_THRESHOLD}`;
                }
            }

            // Toggle near-pity glow effect
            if (container) {
                if (pity >= SOFT_PITY_START) {
                    container.classList.add('near-pity');
                } else {
                    container.classList.remove('near-pity');
                }
            }
        }

        // ==================== TIER REVEAL ANIMATIONS ====================
        function playTierRevealAnimation(tier) {
            const overlay = document.getElementById('revealOverlay');
            if (!overlay) return Promise.resolve();

            // Remove any existing animation classes
            overlay.classList.remove('reveal-ssr', 'reveal-sr', 'reveal-r', 'active');

            let duration = 300;  // Default for N tier

            if (tier === 'SSR') {
                overlay.classList.add('reveal-ssr', 'active');
                duration = 1500;
            } else if (tier === 'SR') {
                overlay.classList.add('reveal-sr', 'active');
                duration = 800;
            } else if (tier === 'R') {
                overlay.classList.add('reveal-r', 'active');
                duration = 500;
            }

            return new Promise(resolve => {
                setTimeout(() => {
                    overlay.classList.remove('reveal-ssr', 'reveal-sr', 'reveal-r', 'active');
                    resolve();
                }, duration);
            });
        }

        function getCardRevealClass(tier) {
            if (tier === 'SSR') return 'reveal-anim-ssr';
            if (tier === 'SR') return 'reveal-anim-sr';
            if (tier === 'R') return 'reveal-anim-r';
            return '';
        }

        // ==================== HOLOGRAPHIC CARD EFFECT ====================
        function initHoloEffect() {
            const wrapper = document.getElementById('moneyStackWrapper');
            if (!wrapper) return;

            // Mouse movement for 3D tilt
            wrapper.addEventListener('mousemove', handleHoloTilt);
            wrapper.addEventListener('mouseleave', resetHoloTilt);

            // Touch support
            wrapper.addEventListener('touchmove', e => {
                e.preventDefault(); // Prevent scrolling while interacting
                if (e.touches.length === 1) {
                    const touch = e.touches[0];
                    handleHoloTilt({
                        clientX: touch.clientX,
                        clientY: touch.clientY,
                        currentTarget: wrapper
                    });
                }
            }, {
                passive: false
            });
            wrapper.addEventListener('touchend', resetHoloTilt);

            // Device Orientation (Gyroscope) Support for Mobile
            // We set up the listener here, but on iOS it triggers after permission is granted
            if (window.DeviceOrientationEvent) {
                window.addEventListener('deviceorientation', handleGyroscopeTilt);
            }
        }

        // Request permission on iOS 13+ (must be called on user interaction)
        function requestMotionPermission() {
            if (
                typeof DeviceOrientationEvent !== 'undefined' &&
                typeof DeviceOrientationEvent.requestPermission === 'function'
            ) {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleGyroscopeTilt);
                        }
                    })
                    .catch(console.error);
            }
        }

        function handleGyroscopeTilt(e) {
            const wrapper = document.getElementById('moneyStackWrapper');
            if (!wrapper) return;

            // Beta: x-axis (front-to-back tilt) [-180, 180]
            // Gamma: y-axis (left-to-right tilt) [-90, 90]
            const tiltX = e.beta;
            const tiltY = e.gamma;

            // Normalize for effect
            // Limit tilt to reasonable range for effect visibility
            // X: 0 to 40 (tilted up), Y: -30 to 30

            // We want 'neutral' holding position (approx 45deg) to be 0 rotation
            // If phone is flat (0), rotateX should be positive?
            // Let's just create a dynamic feel.

            let rotateX = 0;
            let rotateY = 0;

            if (tiltX !== null && tiltY !== null) {
                // Adjust beta so 45deg is 'center' (holding phone naturally)
                rotateX = (tiltX - 45) * 0.5; // Sensitivity
                rotateY = tiltY * 0.5;

                // Clamp
                rotateX = Math.max(-20, Math.min(20, rotateX));
                rotateY = Math.max(-30, Math.min(30, rotateY));

                wrapper.classList.add('holo-active');
                wrapper.style.transform = `perspective(1000px) rotateX(${-rotateX}deg) rotateY(${rotateY}deg)`;

                const cards = wrapper.querySelectorAll('.money-card');
                cards.forEach(card => {
                    const shine = card.querySelector('.holo-shine');
                    if (shine) {
                        // Map rotation to 0-100% position
                        const xPos = 50 + (rotateY / 30) * 50;
                        const yPos = 50 + (rotateX / 20) * 50;
                        shine.style.backgroundPosition = `${xPos}% ${yPos}%`;
                    }
                });
            }
        }

        function handleHoloTilt(e) {
            const wrapper = e.currentTarget;
            const rect = wrapper.getBoundingClientRect();

            // Use SCREEN coordinates for smoother, less sensitive control
            const screenX = e.clientX;
            const screenY = e.clientY;

            const centerX = window.innerWidth / 2;
            const centerY = window.innerHeight / 2;

            // X-axis movement controls Y-axis rotation (Spin)
            // Range: Move from center to edge of screen = 180 degrees
            const rotateY = ((screenX - centerX) / (window.innerWidth / 2)) * 180;

            // Y-axis movement controls X-axis rotation (Tilt)
            // Range: Max 20 degrees up/down
            const rotateX = ((centerY - screenY) / (window.innerHeight / 2)) * 20;

            // Apply tilt to the WHOLE wrapper
            wrapper.classList.add('holo-active');

            // Apply Transform
            wrapper.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;

            // Update shine on individual cards
            const cards = wrapper.querySelectorAll('.money-card');
            cards.forEach(card => {
                const shine = card.querySelector('.holo-shine');
                if (shine) {
                    // Shine moves based on rotation angle [0-100%]
                    const xPos = 50 + (rotateY / 180) * 50;
                    const yPos = 50 + (rotateX / 20) * 50;
                    shine.style.backgroundPosition = `${xPos}% ${yPos}%`;
                }
            });
        }

        function resetHoloTilt(e) {
            const wrapper = e?.currentTarget || document.getElementById('moneyStackWrapper');
            if (!wrapper) return;

            // Remove active class to re-enable transition for smooth reset
            wrapper.classList.remove('holo-active');
            wrapper.style.transform = 'perspective(1000px) rotateX(0deg) rotateY(0deg)';
        }

        // ==================== TOAST QUEUE SYSTEM ====================
        // Handles both notifications and achievements with reliable animations
        const ToastQueue = {
            queue: [],
            isShowing: false,
            currentToast: null,
            currentTimeout: null,

            // Force browser to acknowledge element before animating
            forceReflow(element) {
                // Reading offsetHeight forces a reflow
                void element.offsetHeight;
            },

            // Show next toast in queue
            showNext() {
                if (this.queue.length === 0) {
                    this.isShowing = false;
                    return;
                }

                this.isShowing = true;
                const { element, duration, onShow, onHide } = this.queue.shift();

                // Remove any existing toast of same type
                if (this.currentToast) {
                    this.currentToast.remove();
                }

                this.currentToast = element;
                document.body.appendChild(element);

                // Force reflow before adding show class
                this.forceReflow(element);

                // Use double rAF for maximum compatibility
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        element.classList.add('show');
                        if (onShow) onShow();
                    });
                });

                // Set up auto-hide
                if (this.currentTimeout) clearTimeout(this.currentTimeout);
                this.currentTimeout = setTimeout(() => {
                    this.hide(element, onHide);
                }, duration);

                // Click to dismiss
                element.onclick = () => this.hide(element, onHide);
            },

            // Hide a toast
            hide(element, onHide) {
                if (!element || !element.parentNode) return;

                element.classList.remove('show');

                setTimeout(() => {
                    if (element.parentNode) element.remove();
                    if (onHide) onHide();
                    if (this.currentToast === element) {
                        this.currentToast = null;
                    }
                    // Show next in queue after a small gap
                    setTimeout(() => this.showNext(), 300);
                }, 500); // Match CSS transition duration
            },

            // Add to queue
            add(element, duration = 4000, onShow = null, onHide = null) {
                this.queue.push({ element, duration, onShow, onHide });

                // If not currently showing, start
                if (!this.isShowing) {
                    this.showNext();
                }
            },

            // Clear all pending toasts
            clear() {
                this.queue = [];
                if (this.currentTimeout) clearTimeout(this.currentTimeout);
                if (this.currentToast) {
                    this.currentToast.remove();
                    this.currentToast = null;
                }
                this.isShowing = false;
            }
        };

        // ==================== ACHIEVEMENTS ====================
        const ACHIEVEMENTS = {
            // Milestone achievements
            'first_pull': { icon: 'üéí', title: 'Kh·ªüi ƒê·∫ßu', desc: 'M·ªü l√¨ x√¨ l·∫ßn ƒë·∫ßu ti√™n' },
            'pull_10': { icon: 'üéØ', title: 'Ng∆∞·ªùi Ch∆°i H·ªá Si√™ng', desc: 'M·ªü 10 l√¨ x√¨' },
            'pull_50': { icon: 'üî•', title: 'Nghi·ªán L√¨ X√¨', desc: 'M·ªü 50 l√¨ x√¨' },
            'pull_100': { icon: 'üíØ', title: 'TrƒÉm Ph√°t TrƒÉm Tr√∫ng', desc: 'M·ªü 100 l√¨ x√¨' },

            // Money milestones (linked to skins)
            'first_500k': { icon: 'ü•â', title: 'Kh·ªüi Nghi·ªáp', desc: 'C√≥ 500k trong v√≠' },
            'millionaire': { icon: 'ü•á', title: 'Tri·ªáu Ph√∫', desc: 'C√≥ 1 Tri·ªáu trong v√≠', skin: 'gold' },
            'five_million': { icon: 'üåà', title: 'ƒê·∫°i Tri·ªáu Ph√∫', desc: 'C√≥ 5 Tri·ªáu trong v√≠', skin: 'holo' },
            'multimillionaire': { icon: 'üíé', title: 'T·ª∑ Ph√∫ Mini', desc: 'C√≥ 10 Tri·ªáu trong v√≠', skin: 'diamond' },

            // Tier achievements
            'first_ssr': { icon: '‚≠ê', title: 'V·∫≠n May ƒê·∫ßu Ti√™n', desc: 'Nh·∫≠n ƒë∆∞·ª£c SSR l·∫ßn ƒë·∫ßu' },
            'ssr_3': { icon: 'üåü', title: 'Sao S√°ng', desc: 'Nh·∫≠n ƒë∆∞·ª£c 3 SSR' },
            'ssr_5': { icon: '‚ú®', title: 'Thi√™n M·ªánh', desc: 'Nh·∫≠n ƒë∆∞·ª£c 5 SSR' },
            'ssr_10': { icon: 'üèÜ', title: 'Th·∫ßn T√†i G√µ C·ª≠a', desc: 'Nh·∫≠n ƒë∆∞·ª£c 10 SSR' },
            'sr_10': { icon: 'üíú', title: 'T√≠m L·ªãm Tim', desc: 'Nh·∫≠n ƒë∆∞·ª£c 10 SR' },

            // Gambling achievements
            'first_gamble_win': { icon: 'üé∞', title: 'C·ªù B·∫°c Nh·∫≠p M√¥n', desc: 'Th·∫Øng c∆∞·ª£c l·∫ßn ƒë·∫ßu' },
            'gamble_win_3': { icon: 'üÉè', title: 'Tay Ch∆°i C√≥ S·ªë', desc: 'Th·∫Øng c∆∞·ª£c 3 l·∫ßn' },
            'gamble_win_5': { icon: 'üëë', title: 'Vua S√≤ng B√†i', desc: 'Th·∫Øng c∆∞·ª£c 5 l·∫ßn' },
            'gambler_fail_5': { icon: 'üí∏', title: 'C·ªù B·∫°c B√°c Th·∫±ng B·∫ßn', desc: 'Thua c∆∞·ª£c 5 l·∫ßn li√™n ti·∫øp' },
            'gambler_fail_10': { icon: 'üï≥Ô∏è', title: 'ƒê√°y V·ª±c S√¢u', desc: 'Thua c∆∞·ª£c 10 l·∫ßn li√™n ti·∫øp' },

            // Unlucky achievements
            'unlucky_5': { icon: 'üåßÔ∏è', title: 'M∆∞a R∆°i', desc: '5 l·∫ßn li√™n ti·∫øp ra N' },
            'unlucky_10': { icon: '‚õàÔ∏è', title: 'Th√°nh Nh·ªç', desc: '10 l·∫ßn li√™n ti·∫øp ra N' },
            'unlucky_15': { icon: 'üå™Ô∏è', title: 'B√£o T·ªë Nh·ªç Nh·∫±n', desc: '15 l·∫ßn li√™n ti·∫øp ra N' },

            // Special achievements
            'first_withdraw': { icon: 'üèß', title: 'R√∫t Ti·ªÅn Th√†nh C√¥ng', desc: 'R√∫t ti·ªÅn l·∫ßn ƒë·∫ßu' },
            'withdraw_1m': { icon: 'üí≥', title: 'Tri·ªáu Ph√∫ Th·ª±c Th·ª•', desc: 'T·ªïng r√∫t 1 tri·ªáu' },
            'comeback': { icon: 'üîÑ', title: 'Ph∆∞·ª£ng Ho√†ng T√°i Sinh', desc: 'T·ª´ 0 ƒë·ªìng l√™n l·∫°i 500k' },
            'all_tiers': { icon: 'üé®', title: 'S∆∞u T·∫ßm ƒê·ªß B·ªô', desc: 'Nh·∫≠n ƒë∆∞·ª£c t·∫•t c·∫£ tier N, R, SR, SSR' }
        };

        // Track which skins are unlocked via achievements
        function getUnlockedSkins(achievements) {
            const skins = [];
            if (achievements.includes('millionaire')) skins.push('gold');
            if (achievements.includes('five_million')) skins.push('holo');
            if (achievements.includes('multimillionaire')) skins.push('diamond');
            return skins;
        }

        function checkAchievements(data) {
            const newUnlocks = [];
            const a = data.achievements;
            const s = data.stats;

            // First pull
            if (s.totalPulls >= 1 && !a.includes('first_pull')) newUnlocks.push('first_pull');

            // Pull milestones
            if (s.totalPulls >= 10 && !a.includes('pull_10')) newUnlocks.push('pull_10');
            if (s.totalPulls >= 50 && !a.includes('pull_50')) newUnlocks.push('pull_50');
            if (s.totalPulls >= 100 && !a.includes('pull_100')) newUnlocks.push('pull_100');

            // Money milestones (use maxBalance for skin persistence)
            const balance = data.maxBalance || data.totalMoney;
            if (balance >= 500000 && !a.includes('first_500k')) newUnlocks.push('first_500k');
            if (balance >= 1000000 && !a.includes('millionaire')) newUnlocks.push('millionaire');
            if (balance >= 5000000 && !a.includes('five_million')) newUnlocks.push('five_million');
            if (balance >= 10000000 && !a.includes('multimillionaire')) newUnlocks.push('multimillionaire');

            // SSR achievements
            const ssrCount = s.tierCounts.SSR || 0;
            if (ssrCount >= 1 && !a.includes('first_ssr')) newUnlocks.push('first_ssr');
            if (ssrCount >= 3 && !a.includes('ssr_3')) newUnlocks.push('ssr_3');
            if (ssrCount >= 5 && !a.includes('ssr_5')) newUnlocks.push('ssr_5');
            if (ssrCount >= 10 && !a.includes('ssr_10')) newUnlocks.push('ssr_10');

            // SR achievements
            const srCount = s.tierCounts.SR || 0;
            if (srCount >= 10 && !a.includes('sr_10')) newUnlocks.push('sr_10');

            // Unlucky streaks
            if (s.consecutiveN >= 5 && !a.includes('unlucky_5')) newUnlocks.push('unlucky_5');
            if (s.consecutiveN >= 10 && !a.includes('unlucky_10')) newUnlocks.push('unlucky_10');
            if (s.consecutiveN >= 15 && !a.includes('unlucky_15')) newUnlocks.push('unlucky_15');

            // Gambling achievements
            const wins = s.gambleWins || 0;
            if (wins >= 1 && !a.includes('first_gamble_win')) newUnlocks.push('first_gamble_win');
            if (wins >= 3 && !a.includes('gamble_win_3')) newUnlocks.push('gamble_win_3');
            if (wins >= 5 && !a.includes('gamble_win_5')) newUnlocks.push('gamble_win_5');

            // Gambling loss streaks
            if (s.consecutiveLosses >= 5 && !a.includes('gambler_fail_5')) newUnlocks.push('gambler_fail_5');
            if (s.consecutiveLosses >= 10 && !a.includes('gambler_fail_10')) newUnlocks.push('gambler_fail_10');

            // First withdraw
            if ((s.totalWithdrawn || 0) > 0 && !a.includes('first_withdraw')) newUnlocks.push('first_withdraw');
            if ((s.totalWithdrawn || 0) >= 1000000 && !a.includes('withdraw_1m')) newUnlocks.push('withdraw_1m');

            // Comeback achievement (was at 0, now at 500k+)
            if (s.hitZero && data.totalMoney >= 500000 && !a.includes('comeback')) newUnlocks.push('comeback');

            // All tiers collected
            const hasAllTiers = (s.tierCounts.N || 0) > 0 &&
                (s.tierCounts.R || 0) > 0 &&
                (s.tierCounts.SR || 0) > 0 &&
                (s.tierCounts.SSR || 0) > 0;
            if (hasAllTiers && !a.includes('all_tiers')) newUnlocks.push('all_tiers');

            if (newUnlocks.length > 0) {
                data.achievements.push(...newUnlocks);
                saveData(data);
                // Queue all achievements - they'll show one by one automatically
                newUnlocks.forEach(id => {
                    showAchievementToast(ACHIEVEMENTS[id]);
                });
            }
        }

        function renderAchievements() {
            const data = getData();
            const list = document.getElementById('achievementsList');
            list.innerHTML = '';

            if (data.achievements.length === 0) {
                list.innerHTML = '<span style="color:#888;font-style:italic;">Ch∆∞a c√≥ th√†nh t·ª±u n√†o...</span>';
                return;
            }

            // Sort achievements: skin unlocks first, then others
            const sortedAchievements = [...data.achievements].sort((a, b) => {
                const aHasSkin = ACHIEVEMENTS[a]?.skin ? 0 : 1;
                const bHasSkin = ACHIEVEMENTS[b]?.skin ? 0 : 1;
                return aHasSkin - bHasSkin;
            });

            sortedAchievements.forEach(id => {
                const achi = ACHIEVEMENTS[id];
                if (!achi) return;

                const badge = document.createElement('div');
                badge.className = 'achievement-badge';

                // Add skin class if this achievement unlocks a skin
                if (achi.skin) {
                    badge.classList.add(`skin-${achi.skin}`);
                }

                badge.innerHTML = `
                    <span class="achi-icon">${achi.icon}</span>
                    ${achi.skin ? `<span class="skin-indicator">${achi.skin === 'gold' ? 'ü•á' : achi.skin === 'holo' ? 'üåà' : 'üíé'}</span>` : ''}
                `;
                badge.title = `${achi.title}: ${achi.desc}`;
                list.appendChild(badge);
            });

            // Show progress
            const totalAchievements = Object.keys(ACHIEVEMENTS).length;
            const unlocked = data.achievements.length;
            const progressEl = document.createElement('div');
            progressEl.className = 'achievement-progress';
            progressEl.innerHTML = `<small>ƒê√£ m·ªü kh√≥a: ${unlocked}/${totalAchievements}</small>`;
            list.appendChild(progressEl);
        }

        function showAchievementToast(achi) {
            if (!achi) return;

            const toast = document.createElement('div');
            toast.className = 'achievement-toast';

            // Check if this achievement unlocks a skin
            const skinText = achi.skin ? `<div class="skin-unlock">üé® M·ªü kh√≥a Skin ${achi.skin === 'gold' ? 'V√†ng' : achi.skin === 'holo' ? 'Hologram' : 'Kim C∆∞∆°ng'}!</div>` : '';

            toast.innerHTML = `
                <div class="icon">${achi.icon}</div>
                <div class="info">
                    <div class="title">üèÜ Th√†nh T·ª±u M·ªõi!</div>
                    <div class="desc">${achi.title}: ${achi.desc}</div>
                    ${skinText}
                </div>
            `;

            const duration = achi.skin ? 5000 : 3500;

            ToastQueue.add(toast, duration, () => {
                // onShow callback
                if (achi.skin) {
                    playSound('ssr');
                    vibrate([100, 50, 100, 50, 100]);
                    checkSkinUnlock();
                } else {
                    playSound('coin');
                    vibrate(50);
                }
            });
        }

        // ==================== ZODIAC ====================
        const ZODIACS = [
            { icon: 'üêÅ', name: 'T√Ω' }, { icon: 'üêÇ', name: 'S·ª≠u' }, { icon: 'üêÖ', name: 'D·∫ßn' }, { icon: 'üêà', name: 'M√£o' },
            { icon: 'üêâ', name: 'Th√¨n' }, { icon: 'üêç', name: 'T·ªµ' }, { icon: 'üêé', name: 'Ng·ªç' }, { icon: 'üêê', name: 'M√πi' },
            { icon: 'üêí', name: 'Th√¢n' }, { icon: 'üêì', name: 'D·∫≠u' }, { icon: 'üêï', name: 'Tu·∫•t' }, { icon: 'üêñ', name: 'H·ª£i' }
        ];

        function renderZodiac() {
            const grid = document.getElementById('zodiacGrid');
            if (grid.children.length > 0) return;

            ZODIACS.forEach((z, idx) => {
                const btn = document.createElement('button');
                btn.className = 'zodiac-btn';
                btn.textContent = z.icon;
                btn.title = z.name;
                btn.onclick = () => showFortune(idx);
                grid.appendChild(btn);
            });
        }

        function showFortune(zodiacIndex) {
            const fortunes = [
                "ƒê·∫ßu t∆∞ sinh l·ªùi, code kh√¥ng bug! üöÄ",
                "T√¨nh duy√™n thƒÉng hoa, server c≈©ng 'k·∫øt n·ªëi' t·ªët! ‚ù§Ô∏è",
                "C·∫©n th·∫≠n deadline, nh∆∞ng ti·ªÅn v·ªÅ nh∆∞ n∆∞·ªõc! üíß",
                "Qu√Ω nh√¢n ph√π tr·ª£, deploy m·ªôt ph√°t ƒÉn ngay! ‚ú®",
                "S·ª©c kh·ªèe d·ªìi d√†o, code xuy√™n ƒë√™m kh√¥ng m·ªát! üí™"
            ];
            const resultEl = document.getElementById('fortuneResult');
            resultEl.style.display = 'block';
            resultEl.textContent = `V·∫≠n m·ªánh tu·ªïi ${ZODIACS[zodiacIndex].name}: ${fortunes[Math.floor(Math.random() * fortunes.length)]}`;
        }

        // ==================== FAKE NOTIFICATION ====================
        let notificationTimeout;

        function showFakeNotification(appName, msg, timeAgo, iconChar) {
            // Remove any existing notification
            const existing = document.querySelector('.fake-notification');
            if (existing) {
                existing.classList.remove('show');
                setTimeout(() => existing.remove(), 300);
            }

            const notif = document.createElement('div');
            notif.className = 'fake-notification';

            let iconHtml = iconChar;
            let iconStyle = '';
            const bankInfo = BANKS_DATA.find(b => b.code === iconChar);

            if (bankInfo) {
                iconHtml = `<img src="images/banks/${iconChar}.png" style="width:100%;height:100%;object-fit:contain;" onerror="this.parentElement.textContent='${iconChar.substring(0, 2)}'">`;
                iconStyle = 'background:white;padding:2px;';
                appName = bankInfo.name;
            }

            notif.innerHTML = `
                <div class="fake-notification-header">
                    <div class="app-info">
                        <div class="app-icon" style="${iconStyle}">${iconHtml}</div>
                        <span class="app-name">${appName}</span>
                    </div>
                    <span class="time">${timeAgo}</span>
                </div>
                <div class="fake-notification-content">${msg}</div>
            `;

            notif.onclick = () => {
                notif.classList.remove('show');
                setTimeout(() => notif.remove(), 500);
            };

            document.body.appendChild(notif);

            // Force reflow before adding show class (critical for mobile)
            void notif.offsetHeight;

            // Double rAF for maximum browser compatibility
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    notif.classList.add('show');
                });
            });

            if (notificationTimeout) clearTimeout(notificationTimeout);
            notificationTimeout = setTimeout(() => {
                if (notif.parentNode) {
                    notif.classList.remove('show');
                    setTimeout(() => {
                        if (notif.parentNode) notif.remove();
                    }, 500);
                }
            }, 7000);
        }

        // ==================== ENVELOPE & GAME LOGIC ====================
        // (Keep your existing envelope, gacha, gambling, confetti logic here)
        // ... I'll include a simplified version

        function animateValue(element, start, end, duration) {
            const range = end - start;
            const startTime = performance.now();
            function update(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + range * easeOut);
                element.textContent = formatNumber(current);
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        function typeWriter(element, text, speed = 30) {
            if (element._typingTimeout) clearTimeout(element._typingTimeout);
            element.textContent = '';
            element.classList.add('typing-cursor');
            let i = 0;
            function type() {
                if (i < text.length) {
                    element.textContent += text.charAt(i);
                    i++;
                    element._typingTimeout = setTimeout(type, speed);
                } else {
                    element.classList.remove('typing-cursor');
                }
            }
            type();
        }

        function openEnvelope(luckBonus = 0) {
            if (isOpened) return;
            isOpened = true;

            vibrate(50); // Haptic feedback
            playSound('open');

            document.querySelector('.envelope-flap').style.transform = '';
            envelope.classList.add('opened');
            clickHint.classList.add('hidden');

            // Get current pity counter
            const data = getData();
            const pityCount = data.stats.pityCounter || 0;

            // Calculate SSR rate with pity system
            let ssrRate = BASE_SSR_RATE;  // Base 3%
            if (pityCount >= SOFT_PITY_START) {
                // Soft pity: +3% per pull after threshold
                ssrRate += (pityCount - SOFT_PITY_START + 1) * (SOFT_PITY_BONUS * 100);
            }

            // Add Luck Bonus from Random Event
            if (luckBonus > 0) {
                ssrRate += luckBonus;
                console.log('Luck Bonus Applied:', luckBonus, 'Total SSR Rate:', ssrRate);
            }

            // Hard pity: guaranteed SSR at threshold
            const isHardPity = pityCount >= PITY_THRESHOLD - 1;

            // Gacha Logic with dynamic rates
            const gachaTiers = {
                SSR: { chance: ssrRate, items: [moneyAmounts[5]] },
                SR: { chance: 20, items: [moneyAmounts[4]] },
                R: { chance: 37, items: [moneyAmounts[2], moneyAmounts[3]] },
                N: { chance: 40, items: [moneyAmounts[0], moneyAmounts[1]] }
            };

            function getGachaResult() {
                // Forced SSR on hard pity
                if (isHardPity) {
                    return {
                        tier: 'SSR',
                        bills: [getRandomItem(gachaTiers.SSR.items)],
                        isPity: true
                    };
                }

                const rand = Math.random() * 100;
                let tier = 'N';
                let mainItem = gachaTiers.N.items[0];

                // Cumulative chances
                const ssrThreshold = gachaTiers.SSR.chance;
                const srThreshold = ssrThreshold + gachaTiers.SR.chance;
                const rThreshold = srThreshold + gachaTiers.R.chance;

                if (rand < ssrThreshold) {
                    tier = 'SSR';
                    mainItem = getRandomItem(gachaTiers.SSR.items);
                } else if (rand < srThreshold) {
                    tier = 'SR';
                    mainItem = getRandomItem(gachaTiers.SR.items);
                } else if (rand < rThreshold) {
                    tier = 'R';
                    mainItem = getRandomItem(gachaTiers.R.items);
                } else {
                    tier = 'N';
                    mainItem = getRandomItem(gachaTiers.N.items);
                }

                let bills = [mainItem];
                let bonusChance = tier === 'N' ? 40 : tier === 'R' ? 30 : 20;
                let maxBonus = tier === 'N' ? 5 : tier === 'R' ? 3 : 2;

                for (let i = 0; i < maxBonus; i++) {
                    if (Math.random() * 100 < bonusChance) {
                        bills.push(mainItem);
                    }
                }

                return { tier, bills, isPity: false };
            }

            const happyResult = getGachaResult();
            const totalValue = happyResult.bills.reduce((sum, bill) => sum + bill.value, 0);

            // Update pity counter
            if (happyResult.tier === 'SSR') {
                data.stats.pityCounter = 0;  // Reset on SSR
            } else {
                data.stats.pityCounter = (data.stats.pityCounter || 0) + 1;
            }
            saveData(data);
            updateLuckMeter();

            currentResult = {
                money: happyResult,
                totalValue: totalValue,
                wish: getNextWish()
            };

            // Play tier-specific sounds
            if (currentResult.money.tier === 'SSR') {
                vibrate([50, 30, 50, 30, 100]); // Exciting pattern for SSR
                playSound('ssr');
            } else if (currentResult.money.tier === 'SR') playSound('sr');
            else playSound('coin');

            // Trigger visual reveal animation first
            playTierRevealAnimation(currentResult.money.tier).then(() => {
                resultCard.classList.add('show');
                // Add specific reveal animation class
                const revealClass = getCardRevealClass(currentResult.money.tier);
                if (revealClass) resultCard.classList.add(revealClass);
                resultCard.setAttribute('data-rarity', currentResult.money.tier);

                updateStats(currentResult.money.tier, currentResult.totalValue);
                addToHistory({
                    timestamp: Date.now(),
                    amount: currentResult.totalValue,
                    tier: 'PULL',
                    action: 'pull'
                });

                renderMoneyStack(currentResult.money.bills, currentResult.money.tier);
                animateValue(amountEl, 0, totalValue, 1500);
                addToWallet(totalValue);
                typeWriter(wishEl, currentResult.wish);

                // Initialize holo effect if multiple cards
                setTimeout(() => initHoloEffect(), 100);

                requestAnimationFrame(() => {
                    // Force layout check to ensure element is considered visible by browser
                    const _ = resultCard.offsetHeight;

                    setTimeout(() => {
                        resultCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);
                });

                // Confetti timing based on tier
                const confettiDelay = currentResult.money.tier === 'SSR' ? 1000 : 500;

                setTimeout(() => {
                    createConfetti();
                    if (currentResult.money.tier === 'SSR') {
                        triggerJackpot();
                    }
                }, confettiDelay);
            });
        }

        function renderMoneyStack(bills, tier = 'N') {
            const container = document.getElementById('moneyStackWrapper');
            container.innerHTML = '';

            // Reset flip state
            container.classList.remove('flipped');

            const count = bills.length;
            const visualCount = Math.min(count, 3);

            // ALWAYS remove existing badge first (fixes ghost badge bug)
            const staticContainer = document.getElementById('moneyStackContainer');
            const existingBadge = staticContainer.querySelector('.stack-badge');
            if (existingBadge) existingBadge.remove();

            for (let i = 0; i < visualCount; i++) {
                const card = document.createElement('div');
                card.className = 'money-card';

                let randomRot = 0, offsetX = 0, offsetY = 0;
                if (count > 1) {
                    randomRot = (Math.random() - 0.5) * 12;
                    offsetX = i * 6;
                    offsetY = i * -6;
                }

                card.style.setProperty('--stack-transform', `translate3d(${offsetX}px, ${offsetY}px, ${i * 2}px) rotate(${randomRot}deg)`);
                card.style.zIndex = i;
                card.style.transitionDelay = `${(visualCount - 1 - i) * 0.05}s`;

                const billIndex = visualCount - 1 - i;
                const currentBill = bills[billIndex] || bills[0];

                card.innerHTML = `
                    <div class="holo-shine ${tier}"></div>
                    <div class="money-face money-front">
                        <img src="${currentBill.front}" alt="M·∫∑t tr∆∞·ªõc" loading="lazy">
                    </div>
                    <div class="money-face money-back">
                        <img src="${currentBill.back}" alt="M·∫∑t sau" loading="lazy">
                    </div>
                `;
                container.appendChild(card);
            }

            // Only ADD badge if multiple bills
            if (count > 1) {
                const badge = document.createElement('div');
                badge.className = 'stack-badge';
                badge.textContent = `x${count}`;
                badge.style.cssText = `
                    position:absolute;top:-10px;right:-10px;
                    background:var(--red-primary);color:#fff;font-weight:bold;
                    padding:0.25rem 0.5rem;border-radius:12px;z-index:100;
                    box-shadow:0 2px 5px rgba(0,0,0,0.3);border:2px solid #fff;
                    animation:bounce 0.5s cubic-bezier(0.175,0.885,0.32,1.275) 0.5s both;
                `;
                staticContainer.appendChild(badge);
            }
        }

        function triggerJackpot() {
            document.body.classList.add('jackpot-active');
            const container = document.querySelector('.container');
            container.style.animation = 'none';
            container.offsetHeight;
            container.style.animation = 'shake-hard 0.8s ease-in-out';

            for (let i = 0; i < 3; i++) {
                setTimeout(() => createConfetti(true), i * 300);
            }

            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    if (!isMuted) {
                        const clone = sounds.coin.cloneNode();
                        clone.volume = 0.4;
                        clone.play().catch(e => { });
                    }
                }, i * 150);
            }
        }

        function createConfetti(isJackpot = false) {
            const container = document.getElementById('confetti');
            let emojis = isJackpot ? ['üí∞', '‚ú®', 'üëë', 'üíé', 'üåï'] : ['üêé', 'üßß', 'üí∞', 'üå∏', 'üèÆ', '‚ú®', 'üçÄ'];
            const particleCount = isJackpot ? 60 : 30;

            const fragment = document.createDocumentFragment();
            const particles = []; // Track for cleanup

            for (let i = 0; i < particleCount; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.textContent = emojis[Math.floor(Math.random() * emojis.length)];

                const angle = Math.random() * Math.PI * 2;
                const velocity = (15 + Math.random() * 30) * (isJackpot ? 1.5 : 1);
                const tx = Math.cos(angle) * velocity;
                const ty = Math.sin(angle) * velocity - 20;
                const duration = 1 + Math.random();

                confetti.style.cssText = `left:50%;top:50%;position:absolute;font-size:${Math.random() * 1.5 + 1}rem;transition:all ${duration}s cubic-bezier(0.25,1,0.5,1);opacity:1;background:transparent;width:auto;height:auto;${isJackpot ? 'z-index:2000;' : ''}`;
                confetti.dataset.tx = tx;
                confetti.dataset.ty = ty;
                confetti.dataset.rot = Math.random() * 360;

                particles.push(confetti);
                fragment.appendChild(confetti);
            }
            container.appendChild(fragment);

            // Animate in next frame
            requestAnimationFrame(() => {
                particles.forEach(child => {
                    child.style.transform = `translate(${child.dataset.tx}vw, ${child.dataset.ty}vh) rotate(${child.dataset.rot}deg)`;
                    child.style.opacity = '0';
                });
            });

            // Cleanup all particles after max possible duration + buffer
            setTimeout(() => {
                particles.forEach(p => {
                    if (p.parentNode) p.remove();
                });
            }, 3000);
        }

        function resetEnvelope() {
            isOpened = false;
            resultCard.classList.remove('show');
            document.body.classList.remove('jackpot-active');
            document.getElementById('gambleBtn').disabled = false;
            amountEl.style.color = '';

            setTimeout(() => {
                envelope.classList.remove('opened');
                clickHint.classList.remove('hidden');
                checkSkinUnlock();

                const wBtn = document.getElementById('actionWithdrawBtn');
                if (wBtn) {
                    wBtn.disabled = false;
                    wBtn.textContent = 'üí∏ R√∫t Ti·ªÅn';
                }
            }, 300);
        }

        function gambleAll() {
            // Confirmation dialog
            if (!confirm('‚ö†Ô∏è C∆∞·ª£c T·∫•t Tay!\n\nT·ª∑ l·ªá th·∫Øng: 10% (g·∫•p ƒë√¥i)\nT·ª∑ l·ªá thua: 90% (m·∫•t h·∫øt)\n\nB·∫°n c√≥ ch·∫Øc kh√¥ng?')) {
                return;
            }

            const btn = document.getElementById('gambleBtn');
            btn.disabled = true;

            const currentAmount = currentResult.totalValue;
            const isWin = Math.random() < 0.1;

            if (isWin) {
                vibrate([100, 50, 100, 50, 200]); // Victory pattern
                const newAmount = currentAmount * 2;
                const data = getData();
                data.stats.consecutiveLosses = 0;
                data.stats.gambleWins = (data.stats.gambleWins || 0) + 1;
                saveData(data);
                checkAchievements(data);

                addToHistory({ timestamp: Date.now(), amount: newAmount, tier: 'GAMBLE_WIN', action: 'gamble' });
                addToWallet(currentAmount);
                currentResult.totalValue = newAmount;
                amountEl.style.color = '#00FF00';
                amountEl.textContent = formatNumber(newAmount);
                playSound('ssr');
                wishEl.textContent = "üéâ KH√îNG TIN ƒê∆Ø·ª¢C! B·∫°n ƒë√£ th·∫Øng c∆∞·ª£c v√† g·∫•p ƒë√¥i t√†i s·∫£n! üé≤";
                createConfetti(true);
            } else {
                vibrate(300); // Long buzz for loss
                const data = getData();
                data.stats.consecutiveLosses = (data.stats.consecutiveLosses || 0) + 1;
                saveData(data);

                addToHistory({ timestamp: Date.now(), amount: -currentAmount, tier: 'GAMBLE_LOSE', action: 'gamble' });
                addToWallet(-currentAmount);

                // Track if user hits zero
                const updatedData = getData();
                if (updatedData.totalMoney <= 0) {
                    updatedData.stats.hitZero = true;
                    saveData(updatedData);
                }
                checkAchievements(updatedData);

                currentResult.totalValue = 0;
                amountEl.style.color = '#555';
                amountEl.textContent = "0";
                wishEl.textContent = "üí∏ Ti·∫øc qu√°! Ch√∫c b·∫°n may m·∫Øn l·∫ßn sau. (M·∫•t tr·∫Øng!)";
            }
        }

        function checkSkinUnlock() {
            const data = getData();
            const achievements = data.achievements || [];
            envelope.classList.remove('skin-gold', 'skin-holo', 'skin-diamond');

            // Skins are unlocked via achievements (persist even if money is spent)
            if (achievements.includes('multimillionaire')) {
                envelope.classList.add('skin-diamond');
            } else if (achievements.includes('five_million')) {
                envelope.classList.add('skin-holo');
            } else if (achievements.includes('millionaire')) {
                envelope.classList.add('skin-gold');
            }
        }

        function resetData() {
            if (confirm('B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a to√†n b·ªô d·ªØ li·ªáu?')) {
                Storage.remove('luckyMoneyData_v2');
                Storage.remove('luckyMoney_data');
                location.reload();
            }
        }

        // ==================== SOUND ====================
        function updateMuteUI() {
            muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
            if (isMuted) {
                muteBtn.classList.add('muted');
            } else {
                muteBtn.classList.remove('muted');
            }
        }

        function toggleMute() {
            isMuted = !isMuted;
            Storage.set('luckyMoney_muted', isMuted);
            updateMuteUI();
        }

        // ==================== SHARE ====================
        let qrcodeObj = null;

        function getSmartShareUrl() {
            const url = new URL(window.location.href);
            return url.toString();
        }

        function showShareModal() {
            const modal = document.getElementById('shareModal');
            const qrContainer = document.getElementById('qrcode');
            const shareUrl = getSmartShareUrl();

            modal.style.display = 'flex';
            document.getElementById('shareUrl').textContent = shareUrl;
            qrContainer.innerHTML = '';

            qrcodeObj = new QRCode(qrContainer, {
                text: shareUrl,
                width: 180,
                height: 180,
                colorDark: "#d90429",
                colorLight: "#ffffff",
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        function hideShareModal() {
            document.getElementById('shareModal').style.display = 'none';
        }

        function copyLink() {
            navigator.clipboard.writeText(getSmartShareUrl()).then(() => {
                const btn = document.querySelector('.btn-copy');
                const original = btn.innerHTML;
                btn.innerHTML = '‚úÖ ƒê√£ ch√©p';
                setTimeout(() => btn.innerHTML = original, 2000);
            });
        }

        function downloadQR() {
            const canvas = document.querySelector('#qrcode canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'lucky-money-qr.png';
                link.href = canvas.toDataURL("image/png");
                link.click();
            }
        }

        // ==================== PARTICLES ====================
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 15; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 15 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }

        // ==================== HAPTIC FEEDBACK ====================
        function vibrate(pattern = 50) {
            if ('vibrate' in navigator) {
                navigator.vibrate(pattern);
            }
        }

        // ==================== THEME & YEAR INIT ====================
        function initTheme() {
            const urlParams = new URLSearchParams(window.location.search);
            const theme = urlParams.get('theme');

            // Dynamic Year
            const paramYear = parseInt(urlParams.get('year'));
            const currentYear = !isNaN(paramYear) ? paramYear : new Date().getFullYear();

            // Lunar year calculation
            const can = ['Canh', 'T√¢n', 'Nh√¢m', 'Qu√Ω', 'Gi√°p', '·∫§t', 'B√≠nh', 'ƒêinh', 'M·∫≠u', 'K·ª∑'];
            const chi = ['Th√¢n', 'D·∫≠u', 'Tu·∫•t', 'H·ª£i', 'T√Ω', 'S·ª≠u', 'D·∫ßn', 'M√£o', 'Th√¨n', 'T·ªµ', 'Ng·ªç', 'M√πi'];
            const emojis = { 'T√Ω': 'üê≠', 'S·ª≠u': 'üêÆ', 'D·∫ßn': 'üêØ', 'M√£o': 'üê±', 'Th√¨n': 'üêâ', 'T·ªµ': 'üêç', 'Ng·ªç': 'üêé', 'M√πi': 'üêê', 'Th√¢n': 'üêµ', 'D·∫≠u': 'üêì', 'Tu·∫•t': 'üê∂', 'H·ª£i': 'üê∑' };

            const lunarCan = can[currentYear % 10];
            const lunarChi = chi[currentYear % 12];
            const lunarEmoji = emojis[lunarChi] || 'üéÜ';
            const lunarName = `${lunarCan} ${lunarChi}`;

            // Update header
            const headerDesc = document.querySelector('.header p');
            if (headerDesc) headerDesc.textContent = `Ch√∫c M·ª´ng NƒÉm M·ªõi ${currentYear} - Xu√¢n ${lunarName} ${lunarEmoji}`;

            const yearTitle = document.getElementById('yearTitle');
            if (yearTitle) yearTitle.textContent = `NƒÉm M·ªõi ${lunarName} ${lunarEmoji}`;

            // Apply theme
            if (theme === 'normal') {
                document.body.classList.add('theme-normal');
                document.title = 'üßß L√¨ X√¨ May M·∫Øn';
                const badge = document.querySelector('.department-badge');
                if (badge) badge.style.display = 'none';
                const ecg = document.querySelector('.ecg-line');
                if (ecg) ecg.style.display = 'none';
                wishes = wishesGeneral;
            }

            wishDeck = []; // Reset wish deck
        }

        // ==================== SHAKE DETECTION ====================
        let lastX, lastY, lastZ, lastShakeTime = 0;
        const SHAKE_THRESHOLD = 25;

        function handleMotion(event) {
            if (isOpened) return;
            const current = event.accelerationIncludingGravity;
            if (!current) return;

            const currentTime = Date.now();
            if ((currentTime - lastShakeTime) > 100) {
                lastShakeTime = currentTime;

                if (lastX === undefined) {
                    lastX = current.x;
                    lastY = current.y;
                    lastZ = current.z;
                    return;
                }

                const deltaX = Math.abs(lastX - current.x);
                const deltaY = Math.abs(lastY - current.y);
                const deltaZ = Math.abs(lastZ - current.z);

                if (deltaX > SHAKE_THRESHOLD || deltaY > SHAKE_THRESHOLD || deltaZ > SHAKE_THRESHOLD) {
                    vibrate(100);
                    openEnvelope();
                }

                lastX = current.x;
                lastY = current.y;
                lastZ = current.z;
            }
        }

        function initShakeDetection() {
            if (typeof DeviceMotionEvent === 'undefined') return;

            if (typeof DeviceMotionEvent.requestPermission === 'function') {
                // iOS 13+ requires permission
                const permissionHandler = () => {
                    DeviceMotionEvent.requestPermission()
                        .then(response => {
                            if (response === 'granted') {
                                window.addEventListener('devicemotion', handleMotion, true);
                            }
                        })
                        .catch(console.error);
                    document.body.removeEventListener('click', permissionHandler);
                };
                document.body.addEventListener('click', permissionHandler);
            } else {
                window.addEventListener('devicemotion', handleMotion, true);
            }
        }

        // ==================== DRAG TO OPEN ====================
        function initDragToOpen() {
            const flap = document.querySelector('.envelope-flap');
            let isDragging = false;
            let startY = 0;
            let currentRotation = 0;

            function startDrag(e) {
                if (isOpened) return;
                isDragging = true;
                startY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                flap.style.transition = 'none';
                if (e.cancelable) e.preventDefault();
            }

            function onDrag(e) {
                if (!isDragging || isOpened) return;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;
                const deltaY = clientY - startY;

                if (deltaY > 0) {
                    currentRotation = Math.min((deltaY / 150) * 180, 180);
                    flap.style.transform = `rotateX(${currentRotation}deg)`;
                }
            }

            function endDrag() {
                if (!isDragging) return;
                isDragging = false;
                flap.style.transition = 'transform 0.6s ease';

                if (currentRotation > 90) {
                    vibrate(100);
                    openEnvelope();
                } else {
                    flap.style.transform = 'rotateX(0deg)';
                }
                currentRotation = 0;
            }

            flap.addEventListener('mousedown', startDrag);
            window.addEventListener('mousemove', onDrag);
            window.addEventListener('mouseup', endDrag);
            flap.addEventListener('touchstart', startDrag, { passive: false });
            window.addEventListener('touchmove', onDrag, { passive: false });
            window.addEventListener('touchend', endDrag);
        }

        // ==================== INIT ====================
        // ==================== RANDOM EVENT LOGIC ====================
        let isTapEventActive = false;
        let tapEventTimer = null;
        let tapEventCount = 0;
        let tapEventDuration = 2000; // 2 seconds (Reduced from 3s for more intensity)

        async function tryOpenEnvelope() {
            if (isOpened) return;

            // Try to request Gyro permission on this interaction (iOS)
            requestMotionPermission();

            const now = Date.now(); // 20% chance to trigger random event if not in jackpot mode
            // and not already having this event
            if (!isTapEventActive && Math.random() < 0.2) {
                startTapEvent();
            } else {
                if (isTapEventActive) {
                    handleTapEventClick();
                } else {
                    openEnvelope();
                }
            }
        }

        function startTapEvent() {
            isTapEventActive = true;
            tapEventCount = 0;

            // Show Overlay
            const overlay = document.getElementById('tapEventOverlay');
            const timerFill = document.getElementById('tapTimerFill');
            const luckDisplay = document.getElementById('tapLuckDisplay');

            overlay.classList.add('active');
            luckDisplay.textContent = '+0%';

            // Animate Timer
            // Reset width first
            timerFill.style.transition = 'none';
            timerFill.style.width = '100%';

            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    timerFill.style.transition = `width ${tapEventDuration}ms linear`;
                    timerFill.style.width = '0%';
                });
            });

            // Start Timer
            tapEventTimer = setTimeout(() => {
                endTapEvent();
            }, tapEventDuration);
        }

        function handleTapEventClick() {
            tapEventCount++;

            // Visual Feedback
            const luckBonus = Math.min(tapEventCount * 5, 50); // 5% per tap, max 50%
            document.getElementById('tapLuckDisplay').textContent = `+${luckBonus}%`;

            // Shake Envelope
            envelope.classList.remove('shake-extreme');
            void envelope.offsetWidth; // force reflow
            envelope.classList.add('shake-extreme');

            // Haptic & Sound
            vibrate(50);
            playSound('coin'); // Use coin sound for taps

            // Remove shake class after animation
            setTimeout(() => {
                envelope.classList.remove('shake-extreme');
            }, 200);
        }

        function endTapEvent() {
            isTapEventActive = false;
            document.getElementById('tapEventOverlay').classList.remove('active');

            // Reset timer bar for next time
            document.getElementById('tapTimerFill').style.width = '100%';
            document.getElementById('tapTimerFill').style.transition = 'none';

            // Calculate Bonus
            const luckBonus = Math.min(tapEventCount * 5, 50); // Max 50% bonus

            // Open Envelope with Bonus
            openEnvelope(luckBonus);
        }

        function init() {
            // Initialize muted state from storage
            isMuted = Storage.get('luckyMoney_muted') === 'true';

            // Theme and year first
            initTheme();

            createParticles();
            updateWalletDisplay();
            updateMuteUI();
            checkSkinUnlock();

            // Event listeners
            // Event listeners
            envelopeContainer.addEventListener('click', tryOpenEnvelope);

            // Holographic Spin enabled - click to flip removed

            // Preload images
            moneyAmounts.forEach(item => {
                new Image().src = item.front;
                new Image().src = item.back;
            });

            // Pre-render banks for instant modal
            setTimeout(() => renderBanks(), 500);

            // Initialize shake and drag features
            initShakeDetection();
            initDragToOpen();
        }

        // Start
        init();
    </script>
</body>

</html>